{% extends 'base.html' %}

{% block title %}NOV-RECO Check-in System{% endblock %}

{% block extra_css %}
  <!-- OpenStreetMap - Mi·ªÖn ph√≠, kh√¥ng c·∫ßn API key -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="{% load static %}{% static 'css/checkin.css' %}">
  <style>
    /* Version: 2025-09-16-01 - Force reload */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    .checkin-page {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: calc(100vh - 60px);
      padding: 20px;
    }

    .container {
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      padding: 20px;
      width: 100%;
      max-width: 500px;
      position: relative;
      overflow: hidden;
    }

    /* Mobile responsive */
    @media (max-width: 768px) {
      body {
        padding: 10px;
      }
      
      .container {
        padding: 15px;
        border-radius: 15px;
        margin: 0;
      }
      
      .map-container {
        height: 250px;
      }
      
      .map-controls {
        margin-top: 15px;
        margin-bottom: 35px;
      }
      
      .form-group {
        margin-bottom: 18px;
      }
      
      .camera-container {
        margin-top: 12px;
        margin-bottom: 22px;
      }
    }

    @media (max-width: 480px) {
      .container {
        padding: 10px;
        border-radius: 10px;
      }
      
      .map-container {
        height: 280px;
      }
      
      .camera-container {
        height: 200px;
        margin-top: 15px;
        margin-bottom: 25px;
      }
      
      .form-group {
        margin-bottom: 20px;
      }
      
      .form-label {
        font-size: 14px;
        margin-bottom: 10px;
      }
      
      .btn {
        padding: 10px 15px;
        font-size: 14px;
      }
      
      .map-controls {
        margin-top: 20px;
        margin-bottom: 40px;
        flex-direction: column;
        gap: 10px;
        align-items: stretch;
      }
      
      .btn-get-location {
        width: 100%;
        padding: 12px;
        font-size: 16px;
      }
      
      .coordinates {
        text-align: center;
        font-size: 12px;
        padding: 8px;
        background: #f7fafc;
        border-radius: 6px;
      }
    }

    .container::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #0A5597, #F5831F);
    }

    .header {
      text-align: center;
      margin-bottom: 30px;
    }

    .header h1 {
      color: #0A5597;
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 8px;
    }

    .header .subtitle {
      color: #718096;
      font-size: 14px;
      line-height: 1.5;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      display: block;
      color: #2d3748;
      font-weight: 600;
      font-size: 14px;
      margin-bottom: 8px;
    }

    .form-input,
    .form-select,
    .form-textarea {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      font-size: 16px;
      transition: all 0.3s ease;
      background: #f8fafc;
    }

    .form-input:focus,
    .form-select:focus,
    .form-textarea:focus {
      outline: none;
      border-color: #0A5597;
      background: white;
      box-shadow: 0 0 0 3px rgba(10, 85, 151, 0.1);
    }

    .form-textarea {
      resize: vertical;
      min-height: 80px;
    }

    .file-upload {
      position: relative;
      display: inline-block;
      width: 100%;
    }

    .file-upload input[type="file"] {
      position: absolute;
      opacity: 0;
      width: 100%;
      height: 100%;
      cursor: pointer;
    }

    .file-upload-label {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      border: 2px dashed #cbd5e0;
      border-radius: 12px;
      background: #f8fafc;
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: center;
    }

    .file-upload-label:hover {
      border-color: #0A5597;
      background: #edf2f7;
    }

    .file-upload-icon {
      font-size: 24px;
      margin-right: 8px;
    }

    .file-upload-text {
      color: #4a5568;
      font-weight: 500;
    }

    .file-preview {
      margin-top: 10px;
      padding: 10px;
      background: #e6fffa;
      border-radius: 8px;
      border: 1px solid #81e6d9;
      display: none;
    }

    .file-preview img {
      max-width: 100%;
      height: auto;
      border-radius: 8px;
    }

    .btn-checkin {
      width: 100%;
      padding: 16px;
      background: linear-gradient(135deg, #0A5597 0%, #F5831F 100%);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .btn-checkin:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(10, 85, 151, 0.3);
    }

    .btn-checkin:active {
      transform: translateY(0);
    }

    .btn-checkin:disabled {
      opacity: 0.7;
      cursor: not-allowed;
      transform: none;
    }

    .loading {
      display: none;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .spinner {
      width: 20px;
      height: 20px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-top: 2px solid white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    .alert {
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 14px;
      display: none;
    }

    .alert-success {
      background: #f0fff4;
      border: 1px solid #9ae6b4;
      color: #22543d;
    }

    .alert-error {
      background: #fed7d7;
      border: 1px solid #feb2b2;
      color: #742a2a;
    }

    .alert-info {
      background: #e6f3ff;
      border: 1px solid #90cdf4;
      color: #2c5282;
    }

    .location-info {
      background: #f7fafc;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 12px;
      margin-top: 8px;
      font-size: 12px;
      color: #4a5568;
      display: none;
    }

    .location-info.show {
      display: block;
    }

    /* User info styles */
    .user-info {
      background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 20px;
    }

    .user-info h3 {
      color: #0A5597;
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .user-details {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      font-size: 14px;
      color: #4a5568;
    }

    .user-detail {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .user-detail-icon {
      font-size: 16px;
    }

    /* Map styles */
    .map-container {
      margin-bottom: 20px;
    }

    .map-wrapper {
      height: 200px;
      border-radius: 12px;
      overflow: hidden;
      border: 2px solid #e2e8f0;
      position: relative;
    }

    #map {
      width: 100%;
      height: 100%;
    }

    .map-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 15px;
      margin-bottom: 30px; /* TƒÉng kho·∫£ng c√°ch gi·ªØa map v√† camera */
      padding: 0 5px;
    }

    .btn-get-location {
      background: #0A5597;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn-get-location:hover {
      background: #1D5795;
      transform: translateY(-1px);
    }

    .btn-get-location:disabled {
      background: #a0aec0;
      cursor: not-allowed;
      transform: none;
    }

    .coordinates {
      font-size: 12px;
      color: #718096;
      font-family: monospace;
    }

    /* Camera styles */
    .camera-container {
      position: relative;
      margin-bottom: 20px;
      margin-top: 10px;
    }

    .camera-preview {
      width: 100%;
      height: 200px;
      background: #f8fafc;
      border: 2px dashed #cbd5e0;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      cursor: pointer;
      transition: all 0.3s ease;
      user-select: none;
    }

    .camera-preview:hover {
      border-color: #0A5597;
      background: #edf2f7;
    }

    .camera-preview.has-image {
      border: 2px solid #0A5597;
      background: white;
    }

    .camera-preview img {
      max-width: 100%;
      max-height: 100%;
      object-fit: cover;
      border-radius: 8px;
    }

    .camera-icon {
      font-size: 48px;
      color: #a0aec0;
      margin-bottom: 8px;
    }

    .camera-text {
      color: #4a5568;
      font-weight: 500;
    }

    .camera-controls {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }

    .btn-camera {
      flex: 1;
      padding: 10px;
      border: 2px solid #0A5597;
      background: white;
      color: #0A5597;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn-camera:hover {
      background: #0A5597;
      color: white;
    }

    .btn-camera.danger {
      border-color: #e53e3e;
      color: #e53e3e;
    }

    .btn-camera.danger:hover {
      background: #e53e3e;
      color: white;
    }

    /* Responsive design */
    @media (max-width: 480px) {
      .checkin-page {
        padding: 10px;
      }
      
      .container {
        padding: 20px;
        border-radius: 16px;
      }
      
      .header h1 {
        font-size: 24px;
      }
    }

    /* Desktop view - keep mobile-like appearance */
    @media (min-width: 768px) {
      .container {
        max-width: 400px;
      }
    }
  </style>
{% endblock %}

{% block content %}
  <div class="checkin-page">
    <div class="container">
    <div class="header">
      <div style="margin-bottom: 15px;">
        <img src="/static/logo.svg" alt="NOV-RECO Logo" style="height: 50px;">
      </div>
      <h1>üìç Check-in System</h1>
      <p class="subtitle">Ch·ª•p ·∫£nh tr·ª±c ti·∫øp v√† l·∫•y v·ªã tr√≠ GPS ƒë·ªÉ check-in</p>
    </div>

    <div id="alert" class="alert"></div>

    <!-- User Information -->
    <div class="user-info">
      <h3>üë§ Th√¥ng tin ng∆∞·ªùi d√πng</h3>
      <div class="user-details">
        <div class="user-detail">
          <span class="user-detail-icon">üë§</span>
          <span id="user-name">ƒêang t·∫£i...</span>
        </div>
        <div class="user-detail">
          <span class="user-detail-icon">üè¢</span>
          <span id="user-department">ƒêang t·∫£i...</span>
        </div>
        <div class="user-detail">
          <span class="user-detail-icon">üÜî</span>
          <span id="user-employee-id">ƒêang t·∫£i...</span>
        </div>
        <div class="user-detail">
          <span class="user-detail-icon">üìß</span>
          <span id="user-email">ƒêang t·∫£i...</span>
        </div>
      </div>
    </div>

    <form id="checkin-form">
      {% csrf_token %}
      <!-- Google Maps -->
      <div class="form-group">
        <label class="form-label">üìç V·ªã tr√≠ hi·ªán t·∫°i</label>
        <div class="map-container">
          <div class="map-wrapper">
            <div id="map"></div>
          </div>
          <div class="map-controls">
            <button type="button" id="btn-get-location" class="btn-get-location">
              üìç L·∫•y t·ªça ƒë·ªô
            </button>
            <div class="coordinates" id="coordinates">
              Ch∆∞a c√≥ v·ªã tr√≠
            </div>
          </div>
        </div>
      </div>

      <!-- Camera Capture -->
      <div class="form-group">
        <label class="form-label">üì∑ ·∫¢nh check-in</label>
        <div class="camera-container">
          <div id="camera-preview" class="camera-preview">
            <div class="camera-icon">üì∑</div>
            <div class="camera-text">Ch·∫°m ƒë·ªÉ ch·ª•p ·∫£nh</div>
          </div>
          <div class="camera-controls">
            <button type="button" id="btn-capture" class="btn-camera">
              üì∑ Ch·ª•p ·∫£nh
            </button>
            <button type="button" id="btn-retake" class="btn-camera danger" style="display: none;">
              üîÑ Ch·ª•p l·∫°i
            </button>
          </div>
        </div>
        <input type="file" id="photo" accept="image/*" capture="environment" style="display: none;">
      </div>

      <div class="form-group">
        <label class="form-label" for="note">üìù Ghi ch√∫ (t√πy ch·ªçn)</label>
        <textarea id="note" class="form-textarea" placeholder="V√≠ d·ª•: Team A, ca 9h..."></textarea>
      </div>

      <button type="submit" id="btn-checkin" class="btn-checkin">
        <span class="btn-text">‚úÖ G·ª≠i Check-in</span>
        <div class="loading">
          <div class="spinner"></div>
          <span>ƒêang x·ª≠ l√Ω...</span>
        </div>
      </button>
    </form>
    </div>
  </div>
{% endblock %}

{% block extra_js %}
<script>
    const api = (p, opt = {}) => {
      const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
      const headers = { 
        'X-Requested-With': 'XMLHttpRequest',
        'X-CSRFToken': csrfToken
      };
      
      return fetch(p, Object.assign({
        headers,
        credentials: 'include'
      }, opt));
    };

    // Global variables
    let map;
    let marker;
    let currentPosition = null;
    let currentPhoto = null;
    let isMapInitialized = false;

    // Utility functions
    function showAlert(message, type = 'error') {
      const alert = document.getElementById('alert');
      alert.className = `alert alert-${type}`;
      alert.textContent = message;
      alert.style.display = 'block';
      setTimeout(() => {
        alert.style.display = 'none';
      }, 5000);
    }

    function setLoading(loading) {
      const btn = document.getElementById('btn-checkin');
      const btnText = btn.querySelector('.btn-text');
      const loadingEl = btn.querySelector('.loading');
      
      if (loading) {
        btn.disabled = true;
        btnText.style.display = 'none';
        loadingEl.style.display = 'flex';
      } else {
        btn.disabled = false;
        btnText.style.display = 'block';
        loadingEl.style.display = 'none';
      }
    }

    // Load user information
    async function loadUserInfo() {
      try {
        const response = await api('/checkin/user-info/');
        
        // Check if redirected to login
        if (response.status === 302 || response.url.includes('/accounts/login/')) {
          showAlert('B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ s·ª≠ d·ª•ng h·ªá th·ªëng. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.', 'error');
          setTimeout(() => {
            window.location.href = '/accounts/login/';
          }, 2000);
          return;
        }
        
        const user = await response.json();

        document.getElementById('user-name').textContent = user.display_name || 'N/A';
        document.getElementById('user-department').textContent = user.department || 'N/A';
        document.getElementById('user-employee-id').textContent = user.employee_id || 'N/A';
        document.getElementById('user-email').textContent = user.email || 'N/A';
      } catch (error) {
        console.error('Error loading user info:', error);
        showAlert('Kh√¥ng th·ªÉ t·∫£i th√¥ng tin ng∆∞·ªùi d√πng. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.', 'error');
        setTimeout(() => {
          window.location.href = '/accounts/login/';
        }, 2000);
      }
    }

    // Initialize OpenStreetMap
    function initMap() {
      try {
        // Initialize map centered on Ho Chi Minh City
        map = L.map('map').setView([10.8231, 106.6297], 15);

        // Add OpenStreetMap tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '¬© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
          maxZoom: 19
        }).addTo(map);

        // Add click listener to map (disabled for manual editing)
        map.on('click', (event) => {
          // Users cannot manually edit position - this is intentional
          // Only GPS location is allowed
          console.log('Map clicked, but manual position editing is disabled');
        });

        isMapInitialized = true;
        console.log('OpenStreetMap initialized successfully');
      } catch (error) {
        console.error('Error initializing map:', error);
        // Show fallback message
        const mapContainer = document.getElementById('map');
        mapContainer.innerHTML = `
          <div style="
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            color: #6c757d;
            text-align: center;
            padding: 20px;
          ">
            <div style="font-size: 48px; margin-bottom: 16px;">üó∫Ô∏è</div>
            <div style="font-size: 16px; font-weight: 500; margin-bottom: 8px;">Kh√¥ng th·ªÉ t·∫£i b·∫£n ƒë·ªì</div>
            <div style="font-size: 14px; color: #868e96;">Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi internet</div>
          </div>
        `;
      }
    }

    // Get current position and update map
    async function getCurrentLocation(showButton = true) {
      const btn = document.getElementById('btn-get-location');
      const coordinates = document.getElementById('coordinates');

      if (showButton) {
        btn.disabled = true;
        btn.textContent = 'üîÑ ƒêang l·∫•y v·ªã tr√≠...';
      }

      try {
        if (!navigator.geolocation) {
          throw new Error('Thi·∫øt b·ªã kh√¥ng h·ªó tr·ª£ ƒë·ªãnh v·ªã');
        }

        const position = await new Promise((resolve, reject) => {
          navigator.geolocation.getCurrentPosition(resolve, reject, {
            enableHighAccuracy: true,
            timeout: 15000,
            maximumAge: 0
          });
        });

        const lat = position.coords.latitude;
        const lng = position.coords.longitude;

        currentPosition = { lat, lng };

        // Update submit button state
        updateSubmitButtonState();

        // Update map if OpenStreetMap is available
        if (map && isMapInitialized) {
          map.setView([lat, lng], 16);
          
          // Remove existing marker if any
          if (marker) {
            map.removeLayer(marker);
          }
          
          // Add new marker
          marker = L.marker([lat, lng]).addTo(map);
          marker.bindPopup('V·ªã tr√≠ hi·ªán t·∫°i').openPopup();
        }

        // Update coordinates display
        coordinates.textContent = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;

        if (showButton) {
          showAlert('ƒê√£ l·∫•y v·ªã tr√≠ th√†nh c√¥ng!', 'success');
        }

      } catch (error) {
            let message = 'Kh√¥ng l·∫•y ƒë∆∞·ª£c v·ªã tr√≠. ';
        switch (error.code) {
          case error.PERMISSION_DENIED:
                message += 'Vui l√≤ng cho ph√©p truy c·∫≠p v·ªã tr√≠.';
                break;
          case error.POSITION_UNAVAILABLE:
                message += 'V·ªã tr√≠ hi·ªán t·∫°i kh√¥ng kh·∫£ d·ª•ng.';
                break;
          case error.TIMEOUT:
                message += 'H·∫øt th·ªùi gian ch·ªù l·∫•y v·ªã tr√≠.';
                break;
              default:
            message += error.message;
        }
        showAlert(message, 'error');
        throw error; // Re-throw for auto-location
      } finally {
        if (showButton) {
          btn.disabled = false;
          btn.textContent = 'üìç L·∫•y t·ªça ƒë·ªô';
        }
      }
    }

    // Camera functions
    let stream = null;
    let video = null;
    let canvas = null;

    function initCamera() {
      const cameraPreview = document.getElementById('camera-preview');
      const btnCapture = document.getElementById('btn-capture');
      const btnRetake = document.getElementById('btn-retake');

      // Open camera function
      const openCameraHandler = async () => {
        try {
          await openCamera();
        } catch (error) {
          console.error('Error opening camera:', error);
          showAlert('Kh√¥ng th·ªÉ m·ªü camera. Vui l√≤ng cho ph√©p truy c·∫≠p camera.', 'error');
        }
      };

      // Capture photo - Open camera directly
      btnCapture.addEventListener('click', openCameraHandler);

      // Camera preview click - Open camera directly
      cameraPreview.addEventListener('click', openCameraHandler);

      // Retake photo
      btnRetake.addEventListener('click', () => {
        currentPhoto = null;
        cameraPreview.innerHTML = `
          <div class="camera-icon">üì∑</div>
          <div class="camera-text">Ch·∫°m ƒë·ªÉ ch·ª•p ·∫£nh</div>
        `;
        cameraPreview.classList.remove('has-image');
        btnCapture.style.display = 'block';
        btnRetake.style.display = 'none';
        stopCamera();
        
        // Re-add click listener for camera preview
        cameraPreview.addEventListener('click', openCameraHandler);
        
        // Update submit button state
        updateSubmitButtonState();
      });
    }

    // Open camera and show live preview
    async function openCamera() {
      try {
        // Check if getUserMedia is supported
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
          throw new Error('Camera not supported');
        }

        // Request camera access
        stream = await navigator.mediaDevices.getUserMedia({
          video: {
            facingMode: 'environment', // Use back camera on mobile
            width: { ideal: 1280 },
            height: { ideal: 720 }
          }
        });

        // Create video element
        video = document.createElement('video');
        video.srcObject = stream;
        video.play();
        video.style.width = '100%';
        video.style.height = '100%';
        video.style.objectFit = 'cover';

        // Create canvas for capturing
        canvas = document.createElement('canvas');
        canvas.width = 1280;
        canvas.height = 720;

        // Update preview
        const cameraPreview = document.getElementById('camera-preview');
        cameraPreview.innerHTML = '';
        cameraPreview.appendChild(video);
        cameraPreview.classList.add('has-image');

        // Update buttons
        const btnCapture = document.getElementById('btn-capture');
        const btnRetake = document.getElementById('btn-retake');
        btnCapture.textContent = 'üì∏ Ch·ª•p ·∫£nh';
        btnCapture.style.display = 'block';
        btnRetake.style.display = 'none';

        // Add capture functionality
        btnCapture.onclick = capturePhoto;

      } catch (error) {
        console.error('Camera error:', error);
        throw error;
      }
    }

    // Capture photo from video stream
    function capturePhoto() {
      if (!video || !canvas) return;

      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

      // Convert to blob
      canvas.toBlob((blob) => {
        if (blob) {
          // Create a File object with proper name and extension
          const file = new File([blob], 'checkin_photo.jpg', {
            type: 'image/jpeg',
            lastModified: Date.now()
          });
          
          currentPhoto = file;
          
          // Update submit button state
          updateSubmitButtonState();
          
          // Show captured image
          const cameraPreview = document.getElementById('camera-preview');
          const img = document.createElement('img');
          img.src = URL.createObjectURL(blob);
          img.style.width = '100%';
          img.style.height = '100%';
          img.style.objectFit = 'cover';
          cameraPreview.innerHTML = '';
          cameraPreview.appendChild(img);

          // Update buttons
          const btnCapture = document.getElementById('btn-capture');
          const btnRetake = document.getElementById('btn-retake');
          btnCapture.style.display = 'none';
          btnRetake.style.display = 'block';

          // Stop camera
          stopCamera();
          
          showAlert('ƒê√£ ch·ª•p ·∫£nh th√†nh c√¥ng!', 'success');
        }
      }, 'image/jpeg', 0.8);
    }

    // Stop camera stream
    function stopCamera() {
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
        stream = null;
      }
      if (video) {
        try {
          video.pause();
          video.srcObject = null;
        } catch (error) {
          console.log('Video pause error (ignored):', error.message);
        }
        video = null;
      }
    }

    // Function to update submit button state
    function updateSubmitButtonState() {
      const btn = document.getElementById('btn-checkin');
      const hasPosition = !!currentPosition;
      const hasPhoto = !!currentPhoto;
      const canSubmit = hasPosition && hasPhoto;
      
      if (canSubmit) {
        btn.disabled = false;
        btn.style.opacity = '1';
        btn.style.cursor = 'pointer';
      } else {
        btn.disabled = true;
        btn.style.opacity = '0.6';
        btn.style.cursor = 'not-allowed';
      }
    }

    // Form submit handler
    document.getElementById('checkin-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      console.log('Form submitted');
      
      // Check if we have position and photo BEFORE setting loading
      if (!currentPosition || !currentPhoto) {
        console.log('Missing data - currentPosition:', !!currentPosition, 'currentPhoto:', !!currentPhoto);
        showAlert('‚ö†Ô∏è Vui l√≤ng l·∫•y v·ªã tr√≠ v√† ch·ª•p ·∫£nh tr∆∞·ªõc khi submit!', 'error');
        return;
      }
      
      try {
        setLoading(true);
        console.log('Loading started');
        console.log('Validation passed, submitting...');

        // Get CSRF token
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        
        // Get current timestamp
        const now = new Date();
        const checkinTime = now.toISOString();
        const checkinTimeFormatted = now.toLocaleString('vi-VN', {
          year: 'numeric',
          month: '2-digit',
          day: '2-digit',
          hour: '2-digit',
          minute: '2-digit',
          second: '2-digit'
        });
        
        console.log('Check-in time:', checkinTimeFormatted);
        
        // Prepare form data
        const form = new FormData();
        form.append('lat', currentPosition.lat);
        form.append('lng', currentPosition.lng);
        form.append('note', document.getElementById('note').value);
        form.append('photo', currentPhoto);
        form.append('checkin_time', checkinTime);
        form.append('csrfmiddlewaretoken', csrfToken);

        // Submit check-in
        console.log('Sending request to /checkin/submit/');
        const r = await fetch('/checkin/submit/', { 
          method: 'POST', 
          body: form,
          credentials: 'include'
        });
        
        console.log('Response status:', r.status);
        console.log('Response URL:', r.url);
        console.log('Response headers:', [...r.headers.entries()]);
        
        // Check if redirected to login
        if (r.status === 302 || r.url.includes('/accounts/login/')) {
          console.log('Redirected to login');
          throw new Error('B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ th·ª±c hi·ªán check-in. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.');
        }
        
        // Check if redirected to success page
        if (r.status === 200 && r.url.includes('/checkin/success/')) {
          console.log('Redirected to success page');
          // Redirect to success page
          window.location.href = r.url;
          return;
        }
        
        if (!r.ok) {
          console.log('Response not OK, trying to parse error');
          try {
            const data = await r.json();
            console.log('Error data:', data);
            throw new Error(data.detail || JSON.stringify(data));
          } catch (parseError) {
            console.log('Could not parse error response:', parseError);
            throw new Error(`HTTP ${r.status}: ${r.statusText}`);
          }
        }

        // If not redirected, show success message
        console.log('Showing success message');
        showAlert(`Check-in th√†nh c√¥ng! üéâ\nTh·ªùi gian: ${checkinTimeFormatted}`, 'success');
        
        // Reset form
        document.getElementById('checkin-form').reset();
        currentPosition = null;
        currentPhoto = null;
        document.getElementById('coordinates').textContent = 'Ch∆∞a c√≥ v·ªã tr√≠';
        
        // Update submit button state
        updateSubmitButtonState();
        
        // Stop camera if running
        stopCamera();
        
        // Reset camera preview
        const cameraPreview = document.getElementById('camera-preview');
        cameraPreview.innerHTML = `
          <div class="camera-icon">üì∑</div>
          <div class="camera-text">Ch·∫°m ƒë·ªÉ ch·ª•p ·∫£nh</div>
        `;
        cameraPreview.classList.remove('has-image');
        
        // Reset buttons
        const btnCapture = document.getElementById('btn-capture');
        const btnRetake = document.getElementById('btn-retake');
        btnCapture.textContent = 'üì∑ Ch·ª•p ·∫£nh';
        btnCapture.style.display = 'block';
        btnRetake.style.display = 'none';
        
        // Re-add click listener for camera preview
        cameraPreview.addEventListener('click', async () => {
          try {
            await openCamera();
          } catch (error) {
            console.error('Error opening camera:', error);
            showAlert('Kh√¥ng th·ªÉ m·ªü camera. Vui l√≤ng cho ph√©p truy c·∫≠p camera.', 'error');
          }
        });
        
      } catch (error) {
        console.error('Submit error:', error);
        showAlert(error.message || 'C√≥ l·ªói x·∫£y ra. Vui l√≤ng th·ª≠ l·∫°i.', 'error');
      } finally {
        setLoading(false);
        console.log('Loading finished');
      }
    });

    // Event listeners
    document.getElementById('btn-get-location').addEventListener('click', getCurrentLocation);

    // Initialize everything
    window.addEventListener('load', () => {
      loadUserInfo();
      // Initialize OpenStreetMap (no API key needed)
      initMap();
      initCamera();
      updateSubmitButtonState();
    });

    // Cleanup camera when page is unloaded
    window.addEventListener('beforeunload', () => {
      stopCamera();
    });
  </script>
{% endblock %}