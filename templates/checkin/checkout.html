{% extends 'base.html' %}
{% load static %}

{% block title %}Check-out - NOV-RECO{% endblock %}

{% block extra_css %}
<link rel="preconnect" href="https://unpkg.com" crossorigin>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin>
<link rel="stylesheet" href="{% static 'css/checkout.css' %}">
{% endblock %}

{% block content %}
<div class="checkin-page">
    <div class="checkin-container">
        <div class="checkin-header">
            <h1 class="checkin-title">
                Check-out
            </h1>
            
            {% if latest_checkin %}
            <!-- Th√¥ng tin Checkin hi·ªán t·∫°i -->
            <div class="checkin-info-card">
                <div class="info-header">
                    <h3><i class="fas fa-info-circle"></i> Th√¥ng tin Check-in hi·ªán t·∫°i</h3>
                </div>
                <div class="checkin-details">
                    <div class="detail-item">
                        <i class="fas fa-clock"></i>
                        <div class="detail-content">
                            <span class="detail-label">Th·ªùi gian Check-in:</span>
                            <span class="detail-value">{{ latest_checkin.created_at|date:"d/m/Y H:i:s" }}</span>
                        </div>
                    </div>
                    <div class="detail-item">
                        <i class="fas fa-map-marker-alt"></i>
                        <div class="detail-content">
                            <span class="detail-label">ƒê·ªãa ƒëi·ªÉm:</span>
                            <span class="detail-value">{{ latest_checkin.get_location_name }}</span>
                        </div>
                    </div>
                    <div class="detail-item">
                        <i class="fas fa-tag"></i>
                        <div class="detail-content">
                            <span class="detail-label">Lo·∫°i:</span>
                            <span class="detail-value">{{ latest_checkin.get_checkin_type_display }}</span>
                        </div>
                    </div>
                    {% if latest_checkin.note %}
                    <div class="detail-item">
                        <i class="fas fa-sticky-note"></i>
                        <div class="detail-content">
                            <span class="detail-label">Ghi ch√∫:</span>
                            <span class="detail-value">{{ latest_checkin.note }}</span>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>

        {% if latest_checkin %}
        <div class="checkin-content">
            <!-- Main Check-out Form -->
            <div id="checkoutForm" class="checkin-form">
                <form id="checkoutFormElement">
                    {% csrf_token %}
                    <input type="hidden" id="checkinId" name="checkin_id" value="{{ latest_checkin.id }}">
                    <input type="hidden" id="lat" name="lat">
                    <input type="hidden" id="lng" name="lng">
                    <input type="hidden" id="address" name="address">
                    
                    <!-- Camera Section -->
                    <div class="camera-section">
                        <div class="section-header">
                            <h3><i class="fas fa-camera"></i> Ch·ª•p ·∫£nh</h3>
                            <p class="section-subtitle">Ch·ª•p ·∫£nh ƒë·ªÉ x√°c minh danh t√≠nh</p>
                        </div>
                        <div class="camera-container">
                            <div id="checkoutCameraPreview" class="camera-preview">
                                <div class="camera-placeholder">
                                    <div class="camera-icon">üì∑</div>
                                    <div class="camera-text">Ch·∫°m ƒë·ªÉ m·ªü camera</div>
                                    <div class="camera-hint">Camera s·∫Ω t·ª± ƒë·ªông l·∫•y v·ªã tr√≠</div>
                                </div>
                            </div>
                            <video id="checkoutVideo" autoplay muted style="display: none;"></video>
                            <canvas id="checkoutCanvas" style="display: none;"></canvas>
                            
                            <!-- Camera Controls -->
                            <div class="camera-controls">
                                <button type="button" id="checkoutCaptureBtn" class="btn-capture">
                                    <i class="fas fa-camera"></i>
                                    <span>Ch·ª•p ·∫£nh</span>
                                </button>
                                <button type="button" id="checkoutSwitchCameraBtn" class="btn-switch">
                                    <i class="fas fa-sync-alt"></i>
                                    <span>ƒê·ªïi camera</span>
                                </button>
                            </div>
                            
                            <!-- Photo Preview -->
                            <div id="checkoutPhotoPreview" class="photo-preview" style="display: none;">
                                <div class="photo-container">
                                    <img id="checkoutPreviewImg" alt="Preview">
                                    <div class="photo-overlay">
                                        <button type="button" id="checkoutRetakeBtn" class="btn-retake">
                                            <i class="fas fa-redo"></i>
                                            <span>Ch·ª•p l·∫°i</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Location Section -->
                    <div class="location-section">
                        <div class="section-header">
                            <h3><i class="fas fa-map-marker-alt"></i> V·ªã tr√≠</h3>
                            <p class="section-subtitle">X√°c ƒë·ªãnh v·ªã tr√≠ hi·ªán t·∫°i c·ªßa b·∫°n</p>
                        </div>
                        
                        <!-- Location Status -->
                        <div class="location-status-container">
                            <div id="locationStatus" class="location-status" style="display: none;">
                                <div class="status-icon">
                                    <i class="fas fa-spinner fa-spin"></i>
                                </div>
                                <div class="status-text">
                                    <span class="status-title">ƒêang l·∫•y v·ªã tr√≠...</span>
                                    <span class="status-subtitle">Vui l√≤ng cho ph√©p truy c·∫≠p v·ªã tr√≠</span>
                                </div>
                            </div>
                            
                            <!-- Location Button -->
                            <button type="button" id="checkoutGetLocationBtn" class="btn-location">
                                <i class="fas fa-location-arrow"></i>
                                <span>L·∫•y v·ªã tr√≠</span>
                            </button>
                        </div>
                        
                        <!-- Location Details -->
                        <div id="checkoutLocationDetails" class="location-details" style="display: none;">
                            <div class="location-info-card">
                                <div class="info-item">
                                    <i class="fas fa-globe"></i>
                                    <div class="info-content">
                                        <span class="info-label">Vƒ© ƒë·ªô</span>
                                        <span class="info-value" id="checkoutCurrentLat">-</span>
                                    </div>
                                </div>
                                <div class="info-item">
                                    <i class="fas fa-globe"></i>
                                    <div class="info-content">
                                        <span class="info-label">Kinh ƒë·ªô</span>
                                        <span class="info-value" id="checkoutCurrentLng">-</span>
                                    </div>
                                </div>
                                <div class="info-item">
                                    <i class="fas fa-crosshairs"></i>
                                    <div class="info-content">
                                        <span class="info-label">ƒê·ªô ch√≠nh x√°c</span>
                                        <span class="info-value" id="checkoutLocationAccuracy">-</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Map for location selection -->
                        <div id="map" class="map-container"></div>
                        
                        <!-- Address Display -->
                        <div id="checkoutAddressDisplay" class="address-display" style="display: none;">
                            <div class="address-card">
                                <div class="address-header">
                                    <i class="fas fa-map-marker-alt"></i>
                                    <span class="address-title">ƒê·ªãa ch·ªâ hi·ªán t·∫°i</span>
                                </div>
                                <div class="address-content">
                                    <p id="checkoutCurrentAddress" class="address-text">ƒêang t·∫£i ƒë·ªãa ch·ªâ...</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Note Section -->
                    <div class="note-section">
                        <div class="section-header">
                            <h3><i class="fas fa-sticky-note"></i> Ghi ch√∫</h3>
                            <p class="section-subtitle">Th√™m ghi ch√∫ cho l·∫ßn check-out n√†y (t√πy ch·ªçn)</p>
                        </div>
                        <div class="note-container">
                            <textarea id="note" name="note" class="note-textarea" rows="3" placeholder="Nh·∫≠p ghi ch√∫ v·ªÅ l·∫ßn check-out n√†y..."></textarea>
                        </div>
                    </div>

                    <!-- Submit Button -->
                    <div class="submit-section">
                        <button type="submit" id="submitBtn" class="btn-submit" disabled>
                            <div class="btn-content">
                                <i class="fas fa-check"></i>
                                <span>Ho√†n th√†nh Check-out</span>
                            </div>
                            <div class="btn-loading" style="display: none;">
                                <i class="fas fa-spinner fa-spin"></i>
                                <span>ƒêang x·ª≠ l√Ω...</span>
                            </div>
                        </button>
                    </div>
                </form>
            </div>
        </div>
        {% else %}
        <div class="no-checkin-card">
            <div class="no-checkin-content">
                <div class="no-checkin-icon">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <h3>Kh√¥ng c√≥ Check-in ƒë·ªÉ Check-out</h3>
                <p>B·∫°n c·∫ßn th·ª±c hi·ªán Check-in tr∆∞·ªõc khi c√≥ th·ªÉ Check-out.</p>
                <a href="{% url 'checkin:action' %}" class="btn btn-primary">
                    <i class="fas fa-plus"></i>
                    Th·ª±c hi·ªán Check-in
                </a>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin></script>
<script src="{% static 'js/checkout.js' %}"></script>
{% endblock %}