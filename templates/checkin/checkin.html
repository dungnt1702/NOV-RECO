{% extends 'base.html' %}
{% load static %}

{% block title %}NOV-RECO Check-in System{% endblock %}

{% block extra_css %}
  <!-- OpenStreetMap - Miễn phí, không cần API key -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="{% static 'css/checkin.css' %}">
{% endblock %}

{% block content %}
  <div class="checkin-page">
    <div class="checkin-container">
      <div class="checkin-header">
        <div style="margin-bottom: 15px;">
          <img src="{% static 'logo.svg' %}" alt="NOV-RECO Logo" style="height: 50px;">
    </div>
        <h1>📍 Check-in System</h1>
        <p class="checkin-subtitle">Chụp ảnh trực tiếp và lấy vị trí GPS để check-in</p>
      </div>

      <!-- Browser Permissions Check -->
      <div class="permissions-check-section">
        <div class="permissions-title">🔐 Kiểm tra quyền truy cập</div>
        <div class="permissions-grid">
          <div class="permission-item">
            <span class="permission-label">📍 GPS/Vị trí:</span>
            <span class="permission-status" id="gps-status">Chưa kiểm tra</span>
            <button type="button" id="btn-test-gps" class="btn-test-permission">Test GPS</button>
          </div>
          <div class="permission-item">
            <span class="permission-label">📷 Camera:</span>
            <span class="permission-status" id="camera-status">Chưa kiểm tra</span>
            <button type="button" id="btn-test-camera" class="btn-test-permission">Test Camera</button>
          </div>
        </div>
        <div class="permissions-help">
          <p><strong>💡 Mẹo:</strong> Nếu không thấy popup yêu cầu quyền, hãy nhấp vào biểu tượng 🔒 bên trái thanh địa chỉ để cấp quyền thủ công.</p>
        </div>
      </div>

      <!-- User Info Section -->
      <div class="user-info-section">
        <div class="user-info-title">👤 Thông tin người dùng</div>
        <div class="user-info-grid">
          <div class="user-info-item">
            <div class="user-info-label">Họ tên</div>
            <div class="user-info-value" id="user-name">Đang tải...</div>
          </div>
          <div class="user-info-item">
            <div class="user-info-label">Email</div>
            <div class="user-info-value" id="user-email">Đang tải...</div>
          </div>
          <div class="user-info-item">
            <div class="user-info-label">Phòng ban</div>
            <div class="user-info-value" id="user-department">Đang tải...</div>
          </div>
          <div class="user-info-item">
            <div class="user-info-label">Vai trò</div>
            <div class="user-info-value" id="user-role">Đang tải...</div>
          </div>
        </div>
      </div>

      <form id="checkin-form" class="checkin-form">
        {% csrf_token %}
        
        <!-- Map Section -->
        <div class="form-group">
          <div class="map-container">
            <div class="map-controls">
              <span class="map-label">🗺️ Vị trí hiện tại</span>
              <button type="button" id="btn-get-location" class="btn-get-location">
                📍 Lấy tọa độ
              </button>
            </div>
            <div id="map"></div>
            <div class="coordinates" id="coordinates">Chưa lấy vị trí</div>
          </div>
        </div>

        <!-- Camera Section -->
        <div class="form-group">
          <label class="form-label">📷 Ảnh check-in</label>
          <div class="camera-container">
            <div id="camera-preview" class="camera-preview">
              <div class="camera-icon">📷</div>
              <div class="camera-text">Chạm để chụp ảnh</div>
            </div>
            <div class="camera-controls">
              <button type="button" id="btn-capture" class="btn-camera">
                📷 Chụp ảnh
              </button>
              <button type="button" id="btn-retake" class="btn-camera danger" style="display: none;">
                🔄 Chụp lại
              </button>
              <button type="button" id="btn-switch-camera" class="btn-camera secondary" style="display: none;" title="Chuyển đổi camera trước/sau">
                🔄 Đổi camera
              </button>
            </div>
          </div>
          <input type="file" id="photo" accept="image/*" capture="environment" style="display: none;">
      </div>

      <div class="form-group">
          <label class="form-label" for="note">📝 Ghi chú (tùy chọn)</label>
        <textarea id="note" class="form-textarea" placeholder="Ví dụ: Team A, ca 9h..."></textarea>
      </div>

      <button type="submit" id="btn-checkin" class="btn-checkin">
          <span class="btn-text">✅ Gửi Check-in</span>
        <div class="loading">
          <div class="spinner"></div>
          <span>Đang xử lý...</span>
        </div>
      </button>
    </form>
  </div>
  </div>

{% endblock %}

{% block extra_js %}
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="{% static 'js/checkin.js' %}"></script>
{% endblock %}