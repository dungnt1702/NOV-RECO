<!doctype html>
<html lang="vi">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>NOV-RECO Check-in System</title>
  <link rel="icon" type="image/png" href="/static/favicon.png">
  <!-- OpenStreetMap - Mi·ªÖn ph√≠, kh√¥ng c·∫ßn API key -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #0A5597 0%, #1D5795 50%, #F5831F 100%);
      min-height: 100vh;
      padding: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .container {
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      padding: 30px;
      width: 100%;
      max-width: 500px;
      position: relative;
      overflow: hidden;
    }

    .container::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #0A5597, #F5831F);
    }

    .header {
      text-align: center;
      margin-bottom: 30px;
    }

    .header h1 {
      color: #0A5597;
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 8px;
    }

    .header .subtitle {
      color: #718096;
      font-size: 14px;
      line-height: 1.5;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      display: block;
      color: #2d3748;
      font-weight: 600;
      font-size: 14px;
      margin-bottom: 8px;
    }

    .form-input,
    .form-select,
    .form-textarea {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      font-size: 16px;
      transition: all 0.3s ease;
      background: #f8fafc;
    }

    .form-input:focus,
    .form-select:focus,
    .form-textarea:focus {
      outline: none;
      border-color: #0A5597;
      background: white;
      box-shadow: 0 0 0 3px rgba(10, 85, 151, 0.1);
    }

    .form-textarea {
      resize: vertical;
      min-height: 80px;
    }

    .file-upload {
      position: relative;
      display: inline-block;
      width: 100%;
    }

    .file-upload input[type="file"] {
      position: absolute;
      opacity: 0;
      width: 100%;
      height: 100%;
      cursor: pointer;
    }

    .file-upload-label {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      border: 2px dashed #cbd5e0;
      border-radius: 12px;
      background: #f8fafc;
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: center;
    }

    .file-upload-label:hover {
      border-color: #0A5597;
      background: #edf2f7;
    }

    .file-upload-icon {
      font-size: 24px;
      margin-right: 8px;
    }

    .file-upload-text {
      color: #4a5568;
      font-weight: 500;
    }

    .file-preview {
      margin-top: 10px;
      padding: 10px;
      background: #e6fffa;
      border-radius: 8px;
      border: 1px solid #81e6d9;
      display: none;
    }

    .file-preview img {
      max-width: 100%;
      height: auto;
      border-radius: 8px;
    }

    .btn-checkin {
      width: 100%;
      padding: 16px;
      background: linear-gradient(135deg, #0A5597 0%, #F5831F 100%);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .btn-checkin:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(10, 85, 151, 0.3);
    }

    .btn-checkin:active {
      transform: translateY(0);
    }

    .btn-checkin:disabled {
      opacity: 0.7;
      cursor: not-allowed;
      transform: none;
    }

    .loading {
      display: none;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .spinner {
      width: 20px;
      height: 20px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-top: 2px solid white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    .alert {
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 14px;
      display: none;
    }

    .alert-success {
      background: #f0fff4;
      border: 1px solid #9ae6b4;
      color: #22543d;
    }

    .alert-error {
      background: #fed7d7;
      border: 1px solid #feb2b2;
      color: #742a2a;
    }

    .location-info {
      background: #f7fafc;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 12px;
      margin-top: 8px;
      font-size: 12px;
      color: #4a5568;
      display: none;
    }

    .location-info.show {
      display: block;
    }

    /* User info styles */
    .user-info {
      background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 20px;
    }

    .user-info h3 {
      color: #0A5597;
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .user-details {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      font-size: 14px;
      color: #4a5568;
    }

    .user-detail {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .user-detail-icon {
      font-size: 16px;
    }

    /* Map styles */
    .map-container {
      margin-bottom: 20px;
    }

    .map-wrapper {
      height: 200px;
      border-radius: 12px;
      overflow: hidden;
      border: 2px solid #e2e8f0;
      position: relative;
    }

    #map {
      width: 100%;
      height: 100%;
    }

    .map-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 10px;
    }

    .btn-get-location {
      background: #0A5597;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn-get-location:hover {
      background: #1D5795;
      transform: translateY(-1px);
    }

    .btn-get-location:disabled {
      background: #a0aec0;
      cursor: not-allowed;
      transform: none;
    }

    .coordinates {
      font-size: 12px;
      color: #718096;
      font-family: monospace;
    }

    /* Camera styles */
    .camera-container {
      position: relative;
      margin-bottom: 20px;
    }

    .camera-preview {
      width: 100%;
      height: 200px;
      background: #f8fafc;
      border: 2px dashed #cbd5e0;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .camera-preview:hover {
      border-color: #0A5597;
      background: #edf2f7;
    }

    .camera-preview.has-image {
      border: 2px solid #0A5597;
      background: white;
    }

    .camera-preview img {
      max-width: 100%;
      max-height: 100%;
      object-fit: cover;
      border-radius: 8px;
    }

    .camera-icon {
      font-size: 48px;
      color: #a0aec0;
      margin-bottom: 8px;
    }

    .camera-text {
      color: #4a5568;
      font-weight: 500;
    }

    .camera-controls {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }

    .btn-camera {
      flex: 1;
      padding: 10px;
      border: 2px solid #0A5597;
      background: white;
      color: #0A5597;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn-camera:hover {
      background: #0A5597;
      color: white;
    }

    .btn-camera.danger {
      border-color: #e53e3e;
      color: #e53e3e;
    }

    .btn-camera.danger:hover {
      background: #e53e3e;
      color: white;
    }

    /* Responsive design */
    @media (max-width: 480px) {
      body {
        padding: 10px;
      }
      
      .container {
        padding: 20px;
        border-radius: 16px;
      }
      
      .header h1 {
        font-size: 24px;
      }
    }

    /* Desktop view - keep mobile-like appearance */
    @media (min-width: 768px) {
      .container {
        max-width: 400px;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <div style="margin-bottom: 15px;">
        <img src="/static/logo.svg" alt="NOV-RECO Logo" style="height: 50px;">
      </div>
      <h1>üìç Check-in System</h1>
      <p class="subtitle">Ch·ª•p ·∫£nh tr·ª±c ti·∫øp v√† l·∫•y v·ªã tr√≠ GPS ƒë·ªÉ check-in</p>
    </div>

    <div id="alert" class="alert"></div>

    <!-- User Information -->
    <div class="user-info">
      <h3>üë§ Th√¥ng tin ng∆∞·ªùi d√πng</h3>
      <div class="user-details">
        <div class="user-detail">
          <span class="user-detail-icon">üë§</span>
          <span id="user-name">ƒêang t·∫£i...</span>
        </div>
        <div class="user-detail">
          <span class="user-detail-icon">üè¢</span>
          <span id="user-department">ƒêang t·∫£i...</span>
        </div>
        <div class="user-detail">
          <span class="user-detail-icon">üÜî</span>
          <span id="user-employee-id">ƒêang t·∫£i...</span>
        </div>
        <div class="user-detail">
          <span class="user-detail-icon">üìß</span>
          <span id="user-email">ƒêang t·∫£i...</span>
        </div>
      </div>
    </div>

    <form id="checkin-form">
      <!-- Google Maps -->
      <div class="form-group">
        <label class="form-label">üìç V·ªã tr√≠ hi·ªán t·∫°i</label>
        <div class="map-container">
          <div class="map-wrapper">
            <div id="map"></div>
          </div>
          <div class="map-controls">
            <button type="button" id="btn-get-location" class="btn-get-location">
              üìç L·∫•y t·ªça ƒë·ªô
            </button>
            <div class="coordinates" id="coordinates">
              Ch∆∞a c√≥ v·ªã tr√≠
            </div>
          </div>
        </div>
      </div>

      <!-- Camera Capture -->
      <div class="form-group">
        <label class="form-label">üì∑ ·∫¢nh check-in</label>
        <div class="camera-container">
          <div id="camera-preview" class="camera-preview">
            <div class="camera-icon">üì∑</div>
            <div class="camera-text">Ch·∫°m ƒë·ªÉ ch·ª•p ·∫£nh</div>
          </div>
          <div class="camera-controls">
            <button type="button" id="btn-capture" class="btn-camera">
              üì∑ Ch·ª•p ·∫£nh
            </button>
            <button type="button" id="btn-retake" class="btn-camera danger" style="display: none;">
              üîÑ Ch·ª•p l·∫°i
            </button>
          </div>
        </div>
        <input type="file" id="photo" accept="image/*" capture="environment" style="display: none;">
      </div>

      <div class="form-group">
        <label class="form-label" for="note">üìù Ghi ch√∫ (t√πy ch·ªçn)</label>
        <textarea id="note" class="form-textarea" placeholder="V√≠ d·ª•: Team A, ca 9h..."></textarea>
      </div>

      <button type="submit" id="btn-checkin" class="btn-checkin">
        <span class="btn-text">‚úÖ G·ª≠i Check-in</span>
        <div class="loading">
          <div class="spinner"></div>
          <span>ƒêang x·ª≠ l√Ω...</span>
        </div>
      </button>
    </form>
  </div>

  <script>
    const api = (p, opt = {}) => fetch(p, Object.assign({
      headers: { 'X-Requested-With': 'XMLHttpRequest' },
      credentials: 'include'
    }, opt));

    // Global variables
    let map;
    let marker;
    let currentPosition = null;
    let currentPhoto = null;
    let isMapInitialized = false;

    // Utility functions
    function showAlert(message, type = 'error') {
      const alert = document.getElementById('alert');
      alert.className = `alert alert-${type}`;
      alert.textContent = message;
      alert.style.display = 'block';
      setTimeout(() => {
        alert.style.display = 'none';
      }, 5000);
    }

    function setLoading(loading) {
      const btn = document.getElementById('btn-checkin');
      const btnText = btn.querySelector('.btn-text');
      const loadingEl = btn.querySelector('.loading');
      
      if (loading) {
        btn.disabled = true;
        btnText.style.display = 'none';
        loadingEl.style.display = 'flex';
      } else {
        btn.disabled = false;
        btnText.style.display = 'block';
        loadingEl.style.display = 'none';
      }
    }

    // Load user information
    async function loadUserInfo() {
      try {
        const response = await api('/checkin/user-info/');
        const user = await response.json();

        document.getElementById('user-name').textContent = user.display_name || 'N/A';
        document.getElementById('user-department').textContent = user.department || 'N/A';
        document.getElementById('user-employee-id').textContent = user.employee_id || 'N/A';
        document.getElementById('user-email').textContent = user.email || 'N/A';
      } catch (error) {
        console.error('Error loading user info:', error);
        showAlert('Kh√¥ng th·ªÉ t·∫£i th√¥ng tin ng∆∞·ªùi d√πng', 'error');
      }
    }

    // Initialize OpenStreetMap
    function initMap() {
      try {
        // Initialize map centered on Ho Chi Minh City
        map = L.map('map').setView([10.8231, 106.6297], 15);

        // Add OpenStreetMap tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '¬© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
          maxZoom: 19
        }).addTo(map);

        // Add click listener to map (disabled for manual editing)
        map.on('click', (event) => {
          // Users cannot manually edit position - this is intentional
          // Only GPS location is allowed
          console.log('Map clicked, but manual position editing is disabled');
        });

        isMapInitialized = true;
        console.log('OpenStreetMap initialized successfully');
      } catch (error) {
        console.error('Error initializing map:', error);
        // Show fallback message
        const mapContainer = document.getElementById('map');
        mapContainer.innerHTML = `
          <div style="
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            color: #6c757d;
            text-align: center;
            padding: 20px;
          ">
            <div style="font-size: 48px; margin-bottom: 16px;">üó∫Ô∏è</div>
            <div style="font-size: 16px; font-weight: 500; margin-bottom: 8px;">Kh√¥ng th·ªÉ t·∫£i b·∫£n ƒë·ªì</div>
            <div style="font-size: 14px; color: #868e96;">Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi internet</div>
          </div>
        `;
      }
    }

    // Get current position and update map
    async function getCurrentLocation() {
      const btn = document.getElementById('btn-get-location');
      const coordinates = document.getElementById('coordinates');

      btn.disabled = true;
      btn.textContent = 'üîÑ ƒêang l·∫•y v·ªã tr√≠...';

      try {
        if (!navigator.geolocation) {
          throw new Error('Thi·∫øt b·ªã kh√¥ng h·ªó tr·ª£ ƒë·ªãnh v·ªã');
        }

        const position = await new Promise((resolve, reject) => {
          navigator.geolocation.getCurrentPosition(resolve, reject, {
            enableHighAccuracy: true,
            timeout: 15000,
            maximumAge: 0
          });
        });

        const lat = position.coords.latitude;
        const lng = position.coords.longitude;

        currentPosition = { lat, lng };

        // Update map if OpenStreetMap is available
        if (map && isMapInitialized) {
          map.setView([lat, lng], 16);
          
          // Remove existing marker if any
          if (marker) {
            map.removeLayer(marker);
          }
          
          // Add new marker
          marker = L.marker([lat, lng]).addTo(map);
          marker.bindPopup('V·ªã tr√≠ hi·ªán t·∫°i').openPopup();
        }

        // Update coordinates display
        coordinates.textContent = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;

        showAlert('ƒê√£ l·∫•y v·ªã tr√≠ th√†nh c√¥ng!', 'success');

      } catch (error) {
            let message = 'Kh√¥ng l·∫•y ƒë∆∞·ª£c v·ªã tr√≠. ';
        switch (error.code) {
          case error.PERMISSION_DENIED:
                message += 'Vui l√≤ng cho ph√©p truy c·∫≠p v·ªã tr√≠.';
                break;
          case error.POSITION_UNAVAILABLE:
                message += 'V·ªã tr√≠ hi·ªán t·∫°i kh√¥ng kh·∫£ d·ª•ng.';
                break;
          case error.TIMEOUT:
                message += 'H·∫øt th·ªùi gian ch·ªù l·∫•y v·ªã tr√≠.';
                break;
              default:
            message += error.message;
        }
        showAlert(message, 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = 'üìç L·∫•y t·ªça ƒë·ªô';
      }
    }

    // Camera functions
    function initCamera() {
      const cameraPreview = document.getElementById('camera-preview');
      const btnCapture = document.getElementById('btn-capture');
      const btnRetake = document.getElementById('btn-retake');
      const photoInput = document.getElementById('photo');

      // Capture photo
      btnCapture.addEventListener('click', () => {
        photoInput.click();
      });

      // Retake photo
      btnRetake.addEventListener('click', () => {
        currentPhoto = null;
        cameraPreview.innerHTML = `
          <div class="camera-icon">üì∑</div>
          <div class="camera-text">Ch·∫°m ƒë·ªÉ ch·ª•p ·∫£nh</div>
        `;
        cameraPreview.classList.remove('has-image');
        btnCapture.style.display = 'block';
        btnRetake.style.display = 'none';
        photoInput.value = '';
      });

      // Handle photo selection
      photoInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
          currentPhoto = file;
          const reader = new FileReader();
          reader.onload = (e) => {
            cameraPreview.innerHTML = `<img src="${e.target.result}" alt="Captured photo">`;
            cameraPreview.classList.add('has-image');
            btnCapture.style.display = 'none';
            btnRetake.style.display = 'block';
          };
          reader.readAsDataURL(file);
        }
      });
    }

    // Form submit handler
    document.getElementById('checkin-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      try {
        setLoading(true);
        
        // Validate form
        if (!currentPosition) {
          showAlert('Vui l√≤ng l·∫•y v·ªã tr√≠ tr∆∞·ªõc khi check-in.', 'error');
          return;
        }
        
        if (!currentPhoto) {
          showAlert('Vui l√≤ng ch·ª•p ·∫£nh check-in.', 'error');
          return;
        }

        // Prepare form data
        const form = new FormData();
        form.append('lat', currentPosition.lat);
        form.append('lng', currentPosition.lng);
        form.append('note', document.getElementById('note').value);
        form.append('photo', currentPhoto);

        // Submit check-in
        const r = await api('/checkin/submit/', { 
          method: 'POST', 
          body: form 
        });
        
        const data = await r.json();
        
        if (!r.ok) {
          throw new Error(data.detail || JSON.stringify(data));
        }

        // Success
        showAlert('Check-in th√†nh c√¥ng! üéâ', 'success');
        
        // Reset form
        document.getElementById('checkin-form').reset();
        currentPosition = null;
        currentPhoto = null;
        document.getElementById('coordinates').textContent = 'Ch∆∞a c√≥ v·ªã tr√≠';
        document.getElementById('camera-preview').innerHTML = `
          <div class="camera-icon">üì∑</div>
          <div class="camera-text">Ch·∫°m ƒë·ªÉ ch·ª•p ·∫£nh</div>
        `;
        document.getElementById('camera-preview').classList.remove('has-image');
        document.getElementById('btn-capture').style.display = 'block';
        document.getElementById('btn-retake').style.display = 'none';
        
      } catch (error) {
        showAlert(error.message || 'C√≥ l·ªói x·∫£y ra. Vui l√≤ng th·ª≠ l·∫°i.', 'error');
      } finally {
        setLoading(false);
      }
    });

    // Event listeners
    document.getElementById('btn-get-location').addEventListener('click', getCurrentLocation);

    // Initialize everything
    window.addEventListener('load', () => {
      loadUserInfo();
      // Initialize OpenStreetMap (no API key needed)
      initMap();
      initCamera();
    });
  </script>
</body>

</html>