{% extends 'base.html' %}

{% block title %}Quản lý Khu vực - NOV-RECO{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
    .area-container {
        max-width: 1400px;
        margin: 20px auto;
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        overflow: hidden;
    }

    .header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        text-align: center;
    }

    .header h1 {
        font-size: 2.5rem;
        margin-bottom: 10px;
        font-weight: 700;
    }

    .header p {
        font-size: 1.1rem;
        opacity: 0.9;
    }

    .nav-buttons {
        display: flex;
        gap: 15px;
        justify-content: center;
        margin-top: 20px;
    }

    .btn {
        padding: 12px 24px;
        border: none;
        border-radius: 25px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }

    .btn-primary {
        background: #4CAF50;
        color: white;
    }

    .btn-primary:hover {
        background: #45a049;
        transform: translateY(-2px);
    }

    .btn-secondary {
        background: #2196F3;
        color: white;
    }

    .btn-secondary:hover {
        background: #1976D2;
        transform: translateY(-2px);
    }

    .btn-danger {
        background: #f44336;
        color: white;
    }

    .btn-danger:hover {
        background: #da190b;
        transform: translateY(-2px);
    }

    .content {
        padding: 30px;
    }

    .area-form {
        background: #f8f9fa;
        padding: 25px;
        border-radius: 15px;
        margin-bottom: 30px;
        border: 2px solid #e9ecef;
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #333;
    }

    .form-group input,
    .form-group textarea {
        width: 100%;
        padding: 12px 15px;
        border: 2px solid #ddd;
        border-radius: 8px;
        font-size: 1rem;
        transition: border-color 0.3s ease;
    }

    .form-group input:focus,
    .form-group textarea:focus {
        outline: none;
        border-color: #667eea;
    }

    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 20px;
    }

    .map-container {
        height: 400px;
        border-radius: 10px;
        margin-bottom: 20px;
        border: 2px solid #ddd;
    }

    .map-controls {
        margin-bottom: 10px;
        display: flex;
        gap: 10px;
        align-items: center;
    }

    .btn-sm {
        padding: 8px 16px;
        font-size: 0.9rem;
    }

    .area-list {
        background: white;
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    .area-item {
        padding: 20px;
        border-bottom: 1px solid #eee;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: background-color 0.3s ease;
    }

    .area-item:hover {
        background-color: #f8f9fa;
    }

    .area-item:last-child {
        border-bottom: none;
    }

    .area-info h3 {
        color: #333;
        margin-bottom: 5px;
    }

    .area-info p {
        color: #666;
        font-size: 0.9rem;
    }

    .area-actions {
        display: flex;
        gap: 10px;
    }

    .btn-sm {
        padding: 8px 16px;
        font-size: 0.9rem;
    }

    .status-badge {
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
    }

    .status-active {
        background: #d4edda;
        color: #155724;
    }

    .status-inactive {
        background: #f8d7da;
        color: #721c24;
    }

    .loading {
        text-align: center;
        padding: 20px;
        color: #666;
    }

    .error {
        background: #f8d7da;
        color: #721c24;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
    }

    .success {
        background: #d4edda;
        color: #155724;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
    }

    @media (max-width: 768px) {
        .area-container {
            margin: 10px;
        }
        
        .form-row {
            grid-template-columns: 1fr;
        }
        
        .area-item {
            flex-direction: column;
            align-items: flex-start;
            gap: 15px;
        }
        
        .area-actions {
            width: 100%;
            justify-content: flex-end;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="area-container">
    <div class="header">
        <h1><i class="fas fa-map-marker-alt"></i> Quản lý Khu vực</h1>
        <p>Định nghĩa các khu vực check-in cho nhân viên</p>
        <div class="nav-buttons">
            <button id="updateCheckinsBtn" class="btn btn-secondary">
                <i class="fas fa-sync-alt"></i> Cập nhật Check-in
            </button>
        </div>
    </div>

    <div class="content">
        <!-- Form tạo khu vực -->
        <div class="area-form">
            <h2><i class="fas fa-plus-circle"></i> Tạo Khu vực Mới</h2>
            <form id="areaForm">
                <div class="form-group">
                    <label for="name">Tên khu vực *</label>
                    <input type="text" id="name" name="name" required>
                </div>
                
                <div class="form-group">
                    <label for="description">Mô tả</label>
                    <textarea id="description" name="description" rows="3"></textarea>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="lat">Vĩ độ *</label>
                        <input type="number" id="lat" name="lat" step="any" required>
                    </div>
                    <div class="form-group">
                        <label for="lng">Kinh độ *</label>
                        <input type="number" id="lng" name="lng" step="any" required>
                    </div>
                    <div class="form-group">
                        <label for="radius_m">Bán kính (mét) *</label>
                        <input type="number" id="radius_m" name="radius_m" min="10" max="10000" value="100" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Bản đồ (Click để chọn vị trí)</label>
                    <div class="map-controls">
                        <button type="button" id="getCurrentLocation" class="btn btn-secondary btn-sm">
                            <i class="fas fa-location-arrow"></i> Lấy vị trí hiện tại
                        </button>
                    </div>
                    <div id="map" class="map-container"></div>
                </div>
                
                <div class="form-group">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Tạo Khu vực
                    </button>
                    <button type="button" id="clearForm" class="btn btn-secondary">
                        <i class="fas fa-eraser"></i> Xóa Form
                    </button>
                </div>
            </form>
        </div>

        <!-- Danh sách khu vực -->
        <div class="area-list">
            <div style="padding: 20px; background: #f8f9fa; border-bottom: 1px solid #eee;">
                <h2><i class="fas fa-list"></i> Danh sách Khu vực</h2>
            </div>
            <div id="areaList">
                <div class="loading">
                    <i class="fas fa-spinner fa-spin"></i> Đang tải...
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    let map;
    let marker;
    let areas = [];

    // Khởi tạo bản đồ
    function initMap() {
        map = L.map('map').setView([20.9970, 105.8028], 13);
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);

        // Click để chọn vị trí
        map.on('click', function(e) {
            const lat = e.latlng.lat;
            const lng = e.latlng.lng;
            
            // Tự động điền tọa độ vào form
            document.getElementById('lat').value = lat.toFixed(6);
            document.getElementById('lng').value = lng.toFixed(6);
            
            // Xóa marker cũ nếu có
            if (marker) {
                map.removeLayer(marker);
            }
            
            // Tạo marker mới tại vị trí click
            marker = L.marker([lat, lng]).addTo(map);
            
            // Cập nhật vòng tròn bán kính
            updateRadiusCircle(lat, lng);
            
            // Hiển thị thông báo
            showMessage(`Đã chọn vị trí: ${lat.toFixed(6)}, ${lng.toFixed(6)}`, 'success');
        });
    }

    // Cập nhật vòng tròn bán kính
    function updateRadiusCircle(lat, lng) {
        const radius = parseInt(document.getElementById('radius_m').value) || 100;
        
        if (window.radiusCircle) {
            map.removeLayer(window.radiusCircle);
        }
        
        window.radiusCircle = L.circle([lat, lng], {
            color: '#667eea',
            fillColor: '#667eea',
            fillOpacity: 0.2,
            radius: radius
        }).addTo(map);
    }

    // Load danh sách khu vực
    async function loadAreas() {
        try {
            const response = await fetch('/checkin/areas/', {
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            });
            
            if (response.ok) {
                areas = await response.json();
                renderAreas();
            } else {
                throw new Error('Lỗi tải danh sách khu vực');
            }
        } catch (error) {
            document.getElementById('areaList').innerHTML = 
                `<div class="error">Lỗi: ${error.message}</div>`;
        }
    }

    // Render danh sách khu vực
    function renderAreas() {
        const container = document.getElementById('areaList');
        
        if (areas.length === 0) {
            container.innerHTML = '<div class="loading">Chưa có khu vực nào</div>';
            return;
        }
        
        container.innerHTML = areas.map(area => `
            <div class="area-item">
                <div class="area-info">
                    <h3>${area.name}</h3>
                    <p><strong>Vị trí:</strong> ${area.lat.toFixed(6)}, ${area.lng.toFixed(6)}</p>
                    <p><strong>Bán kính:</strong> ${area.radius_m}m</p>
                    <p><strong>Tạo bởi:</strong> ${area.created_by_name}</p>
                    <p><strong>Ngày tạo:</strong> ${area.created_at}</p>
                    ${area.description ? `<p><strong>Mô tả:</strong> ${area.description}</p>` : ''}
                </div>
                <div class="area-actions">
                    <span class="status-badge ${area.is_active ? 'status-active' : 'status-inactive'}">
                        ${area.is_active ? 'Hoạt động' : 'Tạm dừng'}
                    </span>
                    <button class="btn btn-secondary btn-sm" onclick="editArea(${area.id})">
                        <i class="fas fa-edit"></i> Sửa
                    </button>
                    <button class="btn btn-danger btn-sm" onclick="deleteArea(${area.id})">
                        <i class="fas fa-trash"></i> Xóa
                    </button>
                </div>
            </div>
        `).join('');
    }

    // Tạo khu vực mới
    document.getElementById('areaForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const data = Object.fromEntries(formData.entries());
        
        try {
            const response = await fetch('/checkin/areas/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify(data)
            });
            
            if (response.ok) {
                showMessage('Tạo khu vực thành công!', 'success');
                this.reset();
                if (marker) {
                    map.removeLayer(marker);
                    marker = null;
                }
                if (window.radiusCircle) {
                    map.removeLayer(window.radiusCircle);
                    window.radiusCircle = null;
                }
                loadAreas();
            } else {
                const error = await response.json();
                throw new Error(error.error || 'Lỗi tạo khu vực');
            }
        } catch (error) {
            showMessage(`Lỗi: ${error.message}`, 'error');
        }
    });

    // Xóa form
    document.getElementById('clearForm').addEventListener('click', function() {
        document.getElementById('areaForm').reset();
        if (marker) {
            map.removeLayer(marker);
            marker = null;
        }
        if (window.radiusCircle) {
            map.removeLayer(window.radiusCircle);
            window.radiusCircle = null;
        }
    });

    // Cập nhật vòng tròn khi thay đổi bán kính
    document.getElementById('radius_m').addEventListener('input', function() {
        const lat = parseFloat(document.getElementById('lat').value);
        const lng = parseFloat(document.getElementById('lng').value);
        
        if (!isNaN(lat) && !isNaN(lng)) {
            updateRadiusCircle(lat, lng);
        }
    });

    // Cập nhật vòng tròn khi thay đổi tọa độ thủ công
    document.getElementById('lat').addEventListener('input', function() {
        const lat = parseFloat(this.value);
        const lng = parseFloat(document.getElementById('lng').value);
        
        if (!isNaN(lat) && !isNaN(lng)) {
            updateRadiusCircle(lat, lng);
            if (marker) {
                map.removeLayer(marker);
            }
            marker = L.marker([lat, lng]).addTo(map);
        }
    });

    document.getElementById('lng').addEventListener('input', function() {
        const lat = parseFloat(document.getElementById('lat').value);
        const lng = parseFloat(this.value);
        
        if (!isNaN(lat) && !isNaN(lng)) {
            updateRadiusCircle(lat, lng);
            if (marker) {
                map.removeLayer(marker);
            }
            marker = L.marker([lat, lng]).addTo(map);
        }
    });

    // Xóa khu vực
    async function deleteArea(areaId) {
        if (!confirm('Bạn có chắc chắn muốn xóa khu vực này?')) {
            return;
        }
        
        try {
            const response = await fetch(`/checkin/areas/${areaId}/`, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            });
            
            if (response.ok) {
                showMessage('Xóa khu vực thành công!', 'success');
                loadAreas();
            } else {
                const error = await response.json();
                throw new Error(error.error || 'Lỗi xóa khu vực');
            }
        } catch (error) {
            showMessage(`Lỗi: ${error.message}`, 'error');
        }
    }

    // Sửa khu vực (placeholder)
    function editArea(areaId) {
        alert('Tính năng sửa khu vực sẽ được phát triển trong phiên bản tiếp theo');
    }

    // Hiển thị thông báo
    function showMessage(message, type) {
        const existing = document.querySelector('.error, .success');
        if (existing) {
            existing.remove();
        }
        
        const div = document.createElement('div');
        div.className = type;
        div.textContent = message;
        
        document.querySelector('.content').insertBefore(div, document.querySelector('.area-form'));
        
        setTimeout(() => {
            div.remove();
        }, 5000);
    }

    // Lấy CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Lấy vị trí hiện tại
    document.getElementById('getCurrentLocation').addEventListener('click', function() {
        if (navigator.geolocation) {
            this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang lấy vị trí...';
            this.disabled = true;
            
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    
                    // Điền tọa độ vào form
                    document.getElementById('lat').value = lat.toFixed(6);
                    document.getElementById('lng').value = lng.toFixed(6);
                    
                    // Xóa marker cũ
                    if (marker) {
                        map.removeLayer(marker);
                    }
                    
                    // Tạo marker mới
                    marker = L.marker([lat, lng]).addTo(map);
                    
                    // Cập nhật vòng tròn bán kính
                    updateRadiusCircle(lat, lng);
                    
                    // Di chuyển bản đồ đến vị trí hiện tại
                    map.setView([lat, lng], 15);
                    
                    // Hiển thị thông báo
                    showMessage(`Đã lấy vị trí hiện tại: ${lat.toFixed(6)}, ${lng.toFixed(6)}`, 'success');
                    
                    // Khôi phục nút
                    document.getElementById('getCurrentLocation').innerHTML = '<i class="fas fa-location-arrow"></i> Lấy vị trí hiện tại';
                    document.getElementById('getCurrentLocation').disabled = false;
                },
                function(error) {
                    let message = 'Lỗi lấy vị trí: ';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            message += 'Bị từ chối quyền truy cập vị trí';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            message += 'Vị trí không khả dụng';
                            break;
                        case error.TIMEOUT:
                            message += 'Hết thời gian chờ';
                            break;
                        default:
                            message += 'Lỗi không xác định';
                            break;
                    }
                    showMessage(message, 'error');
                    
                    // Khôi phục nút
                    document.getElementById('getCurrentLocation').innerHTML = '<i class="fas fa-location-arrow"></i> Lấy vị trí hiện tại';
                    document.getElementById('getCurrentLocation').disabled = false;
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 60000
                }
            );
        } else {
            showMessage('Trình duyệt không hỗ trợ định vị', 'error');
        }
    });

    // Cập nhật check-in
    document.getElementById('updateCheckinsBtn').addEventListener('click', async function() {
        if (!confirm('Bạn có chắc chắn muốn cập nhật tất cả check-in dựa trên các khu vực hiện có?')) {
            return;
        }
        
        this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang cập nhật...';
        this.disabled = true;
        
        try {
            const response = await fetch('/checkin/update-checkins-areas/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                }
            });
            
            if (response.ok) {
                const result = await response.json();
                showMessage(`Cập nhật thành công! ${result.output}`, 'success');
            } else {
                const error = await response.json();
                throw new Error(error.error || 'Lỗi cập nhật check-in');
            }
        } catch (error) {
            showMessage(`Lỗi: ${error.message}`, 'error');
        } finally {
            this.innerHTML = '<i class="fas fa-sync-alt"></i> Cập nhật Check-in';
            this.disabled = false;
        }
    });

    // Khởi tạo
    document.addEventListener('DOMContentLoaded', function() {
        initMap();
        loadAreas();
    });
</script>
{% endblock %}
