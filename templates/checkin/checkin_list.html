{% extends 'base.html' %}
{% load static %}

{% block title %}Danh sách Check-in - NOV-RECO{% endblock %}

{% block extra_css %}
  <link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
{% endblock %}

{% block content %}
  <div class="dashboard-container">
    <div class="dashboard-header">
      <h1>Danh sách Check-in</h1>
      <p class="dashboard-subtitle">Xem tất cả check-in trong hệ thống</p>
    </div>

    <div class="dashboard-content">
      <!-- Filters -->
      <div class="filters">
        <div class="filter-group">
          <label class="filter-label">Tìm kiếm</label>
          <input type="text" id="search-input" class="filter-input" placeholder="Tìm theo tên, email...">
        </div>
        <div class="filter-group">
          <label class="filter-label">Từ ngày</label>
          <input type="date" id="date-from" class="filter-input">
        </div>
        <div class="filter-group">
          <label class="filter-label">Đến ngày</label>
          <input type="date" id="date-to" class="filter-input">
        </div>
        <div class="filter-group">
          <label class="filter-label">Người dùng</label>
          <select id="user-filter" class="filter-input">
            <option value="">Tất cả người dùng</option>
          </select>
        </div>
      </div>

      <!-- Check-in List -->
      <div class="table-container">
        <table class="table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Người dùng</th>
              <th>Địa điểm</th>
              <th>Tọa độ</th>
              <th>Khoảng cách</th>
              <th>Thời gian</th>
              <th>Ghi chú</th>
              <th>Ảnh</th>
            </tr>
          </thead>
          <tbody id="checkins-table">
            <!-- Check-ins will be loaded here via JavaScript -->
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      <div id="pagination" class="pagination"></div>

      <!-- Actions -->
      <div class="actions">
        <button onclick="loadCheckins()" class="action-button">
          <i class="fas fa-refresh"></i>
          Tải lại
        </button>
        <button onclick="exportData()" class="action-button success">
          <i class="fas fa-download"></i>
          Xuất dữ liệu
        </button>
        <a href="/checkin/history/" class="action-button secondary">
          <i class="fas fa-history"></i>
          Lịch sử cá nhân
        </a>
      </div>
    </div>
  </div>
{% endblock %}

{% block extra_js %}
  <script src="{% static 'js/base.js' %}"></script>
  <script>
    // Check-in list JavaScript
    let allCheckins = [];
    let filteredCheckins = [];
    let currentPage = 1;
    let totalPages = 1;

    async function loadCheckins() {
      try {
        const response = await api('/checkin/list/');
        if (response.ok) {
          const data = await response.json();
          allCheckins = data.results || [];
          filteredCheckins = [...allCheckins];
          renderCheckinsTable();
          loadUsers();
        }
      } catch (error) {
        console.error('Error loading checkins:', error);
        showAlert('Lỗi tải danh sách check-in', 'error');
      }
    }

    function renderCheckinsTable() {
      const tbody = document.getElementById('checkins-table');
      tbody.innerHTML = filteredCheckins.map(checkin => `
        <tr>
          <td>${checkin.id}</td>
          <td>${checkin.user_name}</td>
          <td>${checkin.location_name}</td>
          <td>${checkin.lat ? checkin.lat.toFixed(6) : 'N/A'}, ${checkin.lng ? checkin.lng.toFixed(6) : 'N/A'}</td>
          <td>${formatDistance(checkin.distance_m || 0)}</td>
          <td>${formatDate(checkin.created_at)}</td>
          <td>${checkin.note || 'N/A'}</td>
          <td>
            ${checkin.photo ? `<img src="${checkin.photo}" alt="Check-in photo" style="width: 50px; height: 50px; object-fit: cover; border-radius: 4px;">` : 'N/A'}
          </td>
        </tr>
      `).join('');
    }

    async function loadUsers() {
      try {
        const response = await api('/checkin/users-api/');
        if (response.ok) {
          const users = await response.json();
          const userSelect = document.getElementById('user-filter');
          userSelect.innerHTML = '<option value="">Tất cả người dùng</option>';
          users.forEach(user => {
            const option = document.createElement('option');
            option.value = user.id;
            option.textContent = user.display_name;
            userSelect.appendChild(option);
          });
        }
      } catch (error) {
        console.error('Error loading users:', error);
      }
    }

    function applyFilters() {
      const searchTerm = document.getElementById('search-input').value.toLowerCase();
      const dateFrom = document.getElementById('date-from').value;
      const dateTo = document.getElementById('date-to').value;
      const userId = document.getElementById('user-filter').value;

      filteredCheckins = allCheckins.filter(checkin => {
        if (searchTerm && !checkin.user_name.toLowerCase().includes(searchTerm) &&
            !(checkin.note && checkin.note.toLowerCase().includes(searchTerm))) {
          return false;
        }
        if (dateFrom) {
          const checkinDate = new Date(checkin.created_at);
          const fromDate = new Date(dateFrom);
          if (checkinDate < fromDate) return false;
        }
        if (dateTo) {
          const checkinDate = new Date(checkin.created_at);
          const toDate = new Date(dateTo);
          toDate.setHours(23, 59, 59, 999);
          if (checkinDate > toDate) return false;
        }
        if (userId && checkin.user_id != userId) {
          return false;
        }
        return true;
      });

      renderCheckinsTable();
    }

    function exportData() {
      showAlert('Tính năng đang phát triển', 'info');
    }

    // Event listeners
    document.addEventListener('DOMContentLoaded', function() {
      loadCheckins();
      
      document.getElementById('search-input').addEventListener('input', debounce(applyFilters, 300));
      document.getElementById('date-from').addEventListener('change', applyFilters);
      document.getElementById('date-to').addEventListener('change', applyFilters);
      document.getElementById('user-filter').addEventListener('change', applyFilters);
    });
  </script>
{% endblock %}
