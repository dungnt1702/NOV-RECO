{% extends 'base.html' %}

{% block title %}Check-in - NOV-RECO{% endblock %}

{% block extra_css %}
<!-- OpenStreetMap - Mi·ªÖn ph√≠, kh√¥ng c·∫ßn API key -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
  /* Version: 2025-09-16-02 - With Navigation */
  .checkin-container {
    background: white;
    border-radius: 20px;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
    padding: 20px;
    width: 100%;
    max-width: 500px;
    margin: 20px auto;
    position: relative;
    overflow: hidden;
  }

  .header {
    text-align: center;
    margin-bottom: 30px;
  }

  .header h1 {
    color: #0A5597;
    font-size: 1.8rem;
    margin-bottom: 10px;
    font-weight: 700;
  }

  .header p {
    color: #666;
    font-size: 1rem;
  }

  .user-info {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 10px;
    margin-bottom: 20px;
    border-left: 4px solid #0A5597;
  }

  .user-info h3 {
    color: #0A5597;
    margin-bottom: 8px;
    font-size: 1.1rem;
  }

  .user-details {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    font-size: 0.9rem;
    color: #666;
  }

  .map-container {
    height: 300px;
    border-radius: 10px;
    margin-bottom: 20px;
    border: 2px solid #ddd;
  }

  .map-controls {
    display: flex;
    justify-content: center;
    margin-top: 15px;
    margin-bottom: 30px;
  }

  .btn-get-coords {
    background: #0A5597;
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 25px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .btn-get-coords:hover {
    background: #083d6b;
    transform: translateY(-2px);
  }

  .btn-get-coords:disabled {
    background: #ccc;
    cursor: not-allowed;
    transform: none;
  }

  .camera-container {
    background: #f8f9fa;
    border: 2px dashed #ddd;
    border-radius: 10px;
    height: 250px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    margin-top: 15px;
    margin-bottom: 30px;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .camera-container:hover {
    border-color: #0A5597;
    background: #f0f7ff;
  }

  .camera-preview {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 8px;
    display: none;
  }

  .camera-placeholder {
    text-align: center;
    color: #666;
  }

  .camera-placeholder i {
    font-size: 3rem;
    color: #0A5597;
    margin-bottom: 15px;
  }

  .camera-placeholder h3 {
    color: #333;
    margin-bottom: 8px;
    font-size: 1.2rem;
  }

  .camera-placeholder p {
    color: #666;
    font-size: 0.9rem;
  }

  .camera-controls {
    margin-top: 15px;
    display: flex;
    gap: 10px;
    justify-content: center;
  }

  .btn-capture {
    background: #28a745;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 20px;
    font-size: 0.9rem;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .btn-capture:hover {
    background: #218838;
    transform: translateY(-2px);
  }

  .btn-retake {
    background: #ffc107;
    color: #212529;
    border: none;
    padding: 10px 20px;
    border-radius: 20px;
    font-size: 0.9rem;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .btn-retake:hover {
    background: #e0a800;
    transform: translateY(-2px);
  }

  .form-group {
    margin-bottom: 20px;
  }

  .form-label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: #333;
  }

  .form-input {
    width: 100%;
    padding: 12px 15px;
    border: 2px solid #ddd;
    border-radius: 8px;
    font-size: 1rem;
    transition: border-color 0.3s ease;
  }

  .form-input:focus {
    outline: none;
    border-color: #0A5597;
  }

  .btn-checkin {
    width: 100%;
    background: linear-gradient(135deg, #0A5597, #F5831F);
    color: white;
    border: none;
    padding: 15px;
    border-radius: 25px;
    font-size: 1.1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    margin-top: 20px;
  }

  .btn-checkin:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(10, 85, 151, 0.3);
  }

  .btn-checkin:disabled {
    background: #ccc;
    cursor: not-allowed;
    transform: none;
    opacity: 0.6;
  }

  .loading {
    display: none;
    text-align: center;
    color: #0A5597;
    font-weight: 600;
  }

  .loading i {
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  .alert {
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 20px;
    font-weight: 500;
  }

  .alert-success {
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
  }

  .alert-error {
    background: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
  }

  .alert-info {
    background: #d1ecf1;
    color: #0c5460;
    border: 1px solid #bee5eb;
  }

  /* Mobile responsive */
  @media (max-width: 768px) {
    .checkin-container {
      margin: 10px;
      padding: 15px;
      border-radius: 15px;
    }
    
    .map-container {
      height: 250px;
    }
    
    .map-controls {
      margin-top: 15px;
      margin-bottom: 35px;
    }
    
    .form-group {
      margin-bottom: 18px;
    }
    
    .camera-container {
      margin-top: 12px;
      margin-bottom: 22px;
    }

    .user-details {
      grid-template-columns: 1fr;
      gap: 5px;
    }
  }

  @media (max-width: 480px) {
    .checkin-container {
      padding: 10px;
      border-radius: 10px;
    }
    
    .map-container {
      height: 280px;
    }
    
    .camera-container {
      height: 200px;
      margin-top: 15px;
      margin-bottom: 25px;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-label {
      font-size: 14px;
      margin-bottom: 10px;
    }
    
    .btn {
      font-size: 0.9rem;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="checkin-container">
  <div class="header">
    <h1><i class="fas fa-map-marker-alt"></i> Check-in</h1>
    <p>Ch·ª•p ·∫£nh v√† ƒë·ªãnh v·ªã v·ªã tr√≠ c·ªßa b·∫°n</p>
  </div>

  <!-- User Info -->
  <div class="user-info" id="userInfo">
    <h3><i class="fas fa-user"></i> Th√¥ng tin ng∆∞·ªùi d√πng</h3>
    <div class="user-details">
      <div><strong>T√™n:</strong> <span id="userName">ƒêang t·∫£i...</span></div>
      <div><strong>Email:</strong> <span id="userEmail">ƒêang t·∫£i...</span></div>
      <div><strong>Ph√≤ng ban:</strong> <span id="userDepartment">ƒêang t·∫£i...</span></div>
      <div><strong>M√£ NV:</strong> <span id="userEmployeeId">ƒêang t·∫£i...</span></div>
    </div>
  </div>

  <!-- Map Section -->
  <div class="form-group">
    <label class="form-label">üìç V·ªã tr√≠ hi·ªán t·∫°i</label>
    <div id="map" class="map-container"></div>
    <div class="map-controls">
      <button type="button" id="btnGetCoords" class="btn-get-coords">
        <i class="fas fa-crosshairs"></i> L·∫•y t·ªça ƒë·ªô
      </button>
    </div>
  </div>

  <!-- Camera Section -->
  <div class="form-group">
    <label class="form-label">üì∑ ·∫¢nh check-in</label>
    <div class="camera-container" id="cameraContainer">
      <video id="video" autoplay style="display: none; width: 100%; height: 100%; object-fit: cover;"></video>
      <canvas id="canvas" style="display: none;"></canvas>
      <img id="cameraPreview" class="camera-preview" alt="Camera preview">
      <div class="camera-placeholder" id="cameraPlaceholder">
        <i class="fas fa-camera"></i>
        <h3>Ch·∫°m ƒë·ªÉ ch·ª•p ·∫£nh</h3>
        <p>Nh·∫•n n√∫t b√™n d∆∞·ªõi ho·∫∑c ch·∫°m v√†o ƒë√¢y</p>
      </div>
      <div class="camera-controls" id="cameraControls" style="display: none;">
        <button type="button" id="btnCapture" class="btn-capture">
          <i class="fas fa-camera"></i> Ch·ª•p ·∫£nh
        </button>
        <button type="button" id="btnRetake" class="btn-retake">
          <i class="fas fa-redo"></i> Ch·ª•p l·∫°i
        </button>
      </div>
    </div>
  </div>

  <!-- Form -->
  <form id="checkinForm">
    {% csrf_token %}
    <div class="form-group">
      <label class="form-label">üìù Ghi ch√∫ (t√πy ch·ªçn)</label>
      <textarea id="note" name="note" class="form-input" rows="3" placeholder="Nh·∫≠p ghi ch√∫..."></textarea>
    </div>

    <div class="form-group">
      <label class="form-label">üïê Th·ªùi gian check-in</label>
      <input type="datetime-local" id="checkinTime" name="checkin_time" class="form-input" readonly>
    </div>

    <button type="submit" id="btnCheckin" class="btn-checkin" disabled>
      <i class="fas fa-paper-plane"></i> G·ª≠i Check-in
    </button>
  </form>

  <div class="loading" id="loading">
    <i class="fas fa-spinner"></i> ƒêang x·ª≠ l√Ω...
  </div>
</div>

<script>
  // Global variables
  let map;
  let marker;
  let currentPosition = null;
  let currentPhoto = null;
  let stream = null;

  // Initialize page
  document.addEventListener('DOMContentLoaded', function() {
    loadUserInfo();
    initMap();
    setupEventListeners();
    setCurrentTime();
  });

  // Load user info
  async function loadUserInfo() {
    try {
      const response = await fetch('/checkin/user-info/');
      if (response.ok) {
        const user = await response.json();
        document.getElementById('userName').textContent = user.display_name;
        document.getElementById('userEmail').textContent = user.email;
        document.getElementById('userDepartment').textContent = user.department || 'N/A';
        document.getElementById('userEmployeeId').textContent = user.employee_id || 'N/A';
      }
    } catch (error) {
      console.error('Error loading user info:', error);
    }
  }

  // Initialize map
  function initMap() {
    map = L.map('map').setView([20.9970, 105.8028], 13);
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '¬© OpenStreetMap contributors'
    }).addTo(map);

    // Try to get current location
    getCurrentLocation();
  }

  // Get current location
  function getCurrentLocation() {
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        function(position) {
          const lat = position.coords.latitude;
          const lng = position.coords.longitude;
          
          currentPosition = { lat, lng };
          
          map.setView([lat, lng], 15);
          
          if (marker) {
            map.removeLayer(marker);
          }
          
          marker = L.marker([lat, lng]).addTo(map);
          
          updateSubmitButtonState();
        },
        function(error) {
          console.error('Geolocation error:', error);
          showAlert('Kh√¥ng th·ªÉ l·∫•y v·ªã tr√≠ hi·ªán t·∫°i. Vui l√≤ng s·ª≠ d·ª•ng n√∫t "L·∫•y t·ªça ƒë·ªô".', 'alert-info');
        }
      );
    } else {
      showAlert('Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ ƒë·ªãnh v·ªã. Vui l√≤ng s·ª≠ d·ª•ng n√∫t "L·∫•y t·ªça ƒë·ªô".', 'alert-info');
    }
  }

  // Setup event listeners
  function setupEventListeners() {
    // Get coordinates button
    document.getElementById('btnGetCoords').addEventListener('click', getCurrentLocation);
    
    // Camera controls
    document.getElementById('btnCapture').addEventListener('click', openCameraHandler);
    document.getElementById('btnRetake').addEventListener('click', retakePhoto);
    document.getElementById('cameraContainer').addEventListener('click', openCameraHandler);
    
    // Form submission
    document.getElementById('checkinForm').addEventListener('submit', handleSubmit);
  }

  // Open camera handler
  function openCameraHandler() {
    if (currentPhoto) {
      retakePhoto();
    } else {
      openCamera();
    }
  }

  // Open camera
  async function openCamera() {
    try {
      stream = await navigator.mediaDevices.getUserMedia({ 
        video: { 
          facingMode: 'environment',
          width: { ideal: 1280 },
          height: { ideal: 720 }
        } 
      });
      
      const video = document.getElementById('video');
      video.srcObject = stream;
      video.style.display = 'block';
      
      document.getElementById('cameraPlaceholder').style.display = 'none';
      document.getElementById('cameraControls').style.display = 'flex';
      
      // Show capture button
      document.getElementById('btnCapture').style.display = 'inline-block';
      
    } catch (error) {
      console.error('Camera error:', error);
      showAlert('Kh√¥ng th·ªÉ truy c·∫≠p camera. Vui l√≤ng ki·ªÉm tra quy·ªÅn truy c·∫≠p.', 'alert-error');
    }
  }

  // Capture photo
  function capturePhoto() {
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    
    ctx.drawImage(video, 0, 0);
    
    canvas.toBlob(function(blob) {
      const file = new File([blob], 'checkin_photo.jpg', { type: 'image/jpeg' });
      currentPhoto = file;
      
      // Show preview
      const preview = document.getElementById('cameraPreview');
      preview.src = URL.createObjectURL(blob);
      preview.style.display = 'block';
      
      // Hide video and show controls
      video.style.display = 'none';
      document.getElementById('cameraPlaceholder').style.display = 'none';
      document.getElementById('cameraControls').style.display = 'flex';
      
      // Stop camera
      stopCamera();
      
      updateSubmitButtonState();
    }, 'image/jpeg', 0.8);
  }

  // Retake photo
  function retakePhoto() {
    currentPhoto = null;
    
    // Hide preview
    document.getElementById('cameraPreview').style.display = 'none';
    document.getElementById('cameraPlaceholder').style.display = 'block';
    document.getElementById('cameraControls').style.display = 'none';
    
    updateSubmitButtonState();
  }

  // Stop camera
  function stopCamera() {
    if (stream) {
      stream.getTracks().forEach(track => track.stop());
      stream = null;
    }
    
    const video = document.getElementById('video');
    try {
      video.pause();
      video.srcObject = null;
    } catch (error) {
      console.log('Camera stopped');
    }
  }

  // Set current time
  function setCurrentTime() {
    const now = new Date();
    const timeString = now.toISOString().slice(0, 16);
    document.getElementById('checkinTime').value = timeString;
  }

  // Update submit button state
  function updateSubmitButtonState() {
    const btn = document.getElementById('btnCheckin');
    const hasPosition = currentPosition !== null;
    const hasPhoto = currentPhoto !== null;
    
    if (hasPosition && hasPhoto) {
      btn.disabled = false;
      btn.style.opacity = '1';
      btn.style.cursor = 'pointer';
    } else {
      btn.disabled = true;
      btn.style.opacity = '0.6';
      btn.style.cursor = 'not-allowed';
    }
  }

  // Handle form submission
  async function handleSubmit(e) {
    e.preventDefault();
    
    // Check if we have required data
    if (!currentPosition || !currentPhoto) {
      showAlert('Vui l√≤ng l·∫•y t·ªça ƒë·ªô v√† ch·ª•p ·∫£nh tr∆∞·ªõc khi g·ª≠i check-in.', 'alert-error');
      return;
    }
    
    setLoading(true);
    
    try {
      const formData = new FormData();
      formData.append('lat', currentPosition.lat);
      formData.append('lng', currentPosition.lng);
      formData.append('photo', currentPhoto);
      formData.append('note', document.getElementById('note').value);
      formData.append('checkin_time', document.getElementById('checkinTime').value);
      formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
      
      console.log('Submitting check-in...');
      
      const response = await fetch('/checkin/submit/', {
        method: 'POST',
        body: formData,
        headers: {
          'X-CSRFToken': getCookie('csrftoken')
        }
      });
      
      console.log('Response status:', response.status);
      console.log('Response URL:', response.url);
      
      if (response.ok && response.url.includes('/checkin/success/')) {
        showAlert('Check-in th√†nh c√¥ng! ƒêang chuy·ªÉn h∆∞·ªõng...', 'alert-success');
        setTimeout(() => {
          window.location.href = response.url;
        }, 1500);
      } else if (response.status === 302) {
        // Handle redirect
        const redirectUrl = response.headers.get('Location');
        if (redirectUrl && redirectUrl.includes('/checkin/success/')) {
          showAlert('Check-in th√†nh c√¥ng! ƒêang chuy·ªÉn h∆∞·ªõng...', 'alert-success');
          setTimeout(() => {
            window.location.href = redirectUrl;
          }, 1500);
        } else {
          throw new Error('Redirect kh√¥ng h·ª£p l·ªá');
        }
      } else if (response.status === 302 && response.url.includes('/accounts/login/')) {
        showAlert('Phi√™n ƒëƒÉng nh·∫≠p ƒë√£ h·∫øt h·∫°n. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.', 'alert-error');
        setTimeout(() => {
          window.location.href = '/accounts/login/';
        }, 2000);
      } else {
        const errorData = await response.json();
        throw new Error(errorData.error || 'L·ªói kh√¥ng x√°c ƒë·ªãnh');
      }
      
    } catch (error) {
      console.error('Submit error:', error);
      showAlert(`L·ªói: ${error.message}`, 'alert-error');
    } finally {
      setLoading(false);
    }
  }

  // Set loading state
  function setLoading(loading) {
    const btn = document.getElementById('btnCheckin');
    const loadingDiv = document.getElementById('loading');
    
    if (loading) {
      btn.disabled = true;
      btn.style.opacity = '0.6';
      loadingDiv.style.display = 'block';
    } else {
      updateSubmitButtonState();
      loadingDiv.style.display = 'none';
    }
  }

  // Show alert
  function showAlert(message, type) {
    const existing = document.querySelector('.alert');
    if (existing) {
      existing.remove();
    }
    
    const alert = document.createElement('div');
    alert.className = `alert ${type}`;
    alert.textContent = message;
    
    document.querySelector('.checkin-container').insertBefore(alert, document.querySelector('.user-info'));
    
    setTimeout(() => {
      alert.remove();
    }, 5000);
  }

  // Get CSRF token
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  // Update capture button click handler
  document.getElementById('btnCapture').addEventListener('click', function() {
    if (stream) {
      capturePhoto();
    } else {
      openCamera();
    }
  });
</script>
{% endblock %}
