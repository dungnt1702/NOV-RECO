{% extends "base.html" %}
{% load static %}

{% block title %}Thông tin cá nhân{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/personal/profile.css' %}">
<style>
.alert {
    padding: 1rem 1.5rem;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    animation: slideInRight 0.3s ease;
}

.alert-success {
    background-color: #d4edda;
    border: 1px solid #c3e6cb;
    color: #155724;
}

@keyframes slideInRight {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="personal-profile-page">
    <div class="container">
        <!-- Header -->
        <div class="profile-header">
            <div class="profile-avatar">
                {% if user.avatar %}
                    <img src="{{ user.avatar.url }}" alt="Avatar" class="avatar-image" id="profile-avatar-img">
                {% else %}
                    <div class="avatar-placeholder">
                        <i class="fas fa-user"></i>
                    </div>
                {% endif %}
                <div class="avatar-overlay">
                    <a href="{% url 'personal:avatar_upload' %}" class="btn btn-sm btn-primary">
                        <i class="fas fa-camera"></i> Thay đổi
                    </a>
                </div>
            </div>
            <div class="profile-info">
                <h1 class="profile-name">{{ user.get_display_name }}</h1>
                <p class="profile-role">{{ user.get_role_display }}</p>
                {% if user.department %}
                    <p class="profile-department">{{ user.department.name }}</p>
                {% else %}
                    <p class="profile-department">Chưa phân phòng ban</p>
                {% endif %}
                {% if user.position %}
                    <p class="profile-position">{{ user.position }}</p>
                {% endif %}
            </div>
            <div class="profile-actions">
                <a href="{% url 'personal:edit' %}" class="btn btn-primary">
                    <i class="fas fa-edit"></i> Chỉnh sửa
                </a>
                <a href="{% url 'personal:change_password' %}" class="btn btn-outline">
                    <i class="fas fa-key"></i> Đổi mật khẩu
                </a>
            </div>
        </div>

        <!-- Profile Content -->
        <div class="profile-content">
            <div class="profile-sections">
                <!-- Thông tin cơ bản -->
                <div class="profile-section">
                    <h3 class="section-title">
                        <i class="fas fa-user"></i> Thông tin cơ bản
                    </h3>
                    <div class="section-content">
                        <div class="info-grid">
                            <div class="info-item">
                                <label>Họ tên:</label>
                                <span>{{ user.get_full_name|default:"Chưa cập nhật" }}</span>
                            </div>
                            <div class="info-item">
                                <label>Email:</label>
                                <span>{{ user.email|default:"Chưa cập nhật" }}</span>
                            </div>
                            <div class="info-item">
                                <label>Số điện thoại:</label>
                                <span>{{ user.phone|default:"Chưa cập nhật" }}</span>
                            </div>
                            <div class="info-item">
                                <label>Ngày sinh:</label>
                                <span>{{ user.date_of_birth|date:"d/m/Y"|default:"Chưa cập nhật" }}</span>
                            </div>
                            <div class="info-item">
                                <label>Giới tính:</label>
                                <span>{{ user.get_gender_display|default:"Chưa cập nhật" }}</span>
                            </div>
                            <div class="info-item">
                                <label>Địa chỉ:</label>
                                <span>{{ user.address|default:"Chưa cập nhật" }}</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Thông tin công việc -->
                <div class="profile-section">
                    <h3 class="section-title">
                        <i class="fas fa-briefcase"></i> Thông tin công việc
                    </h3>
                    <div class="section-content">
                        <div class="info-grid">
                            <div class="info-item">
                                <label>Mã nhân viên:</label>
                                <span>{{ user.employee_id|default:"Chưa cập nhật" }}</span>
                            </div>
                            <div class="info-item">
                                <label>Phòng ban:</label>
                                <span>{% if user.department %}{{ user.department.name }}{% else %}Chưa phân phòng ban{% endif %}</span>
                            </div>
                            <div class="info-item">
                                <label>Chức vụ:</label>
                                <span>{{ user.position|default:"Chưa cập nhật" }}</span>
                            </div>
                            <div class="info-item">
                                <label>Ngày vào làm:</label>
                                <span>{{ user.hire_date|date:"d/m/Y"|default:"Chưa cập nhật" }}</span>
                            </div>
                            <div class="info-item">
                                <label>Lịch làm việc:</label>
                                <span>{{ user.work_schedule|default:"Chưa cập nhật" }}</span>
                            </div>
                            <div class="info-item">
                                <label>Trạng thái:</label>
                                <span class="status-badge {{ user.is_active_employee|yesno:'active,inactive' }}">
                                    {{ user.is_active_employee|yesno:"Đang hoạt động,Tạm nghỉ" }}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Thông tin liên hệ khẩn cấp -->
                <div class="profile-section">
                    <h3 class="section-title">
                        <i class="fas fa-phone"></i> Liên hệ khẩn cấp
                    </h3>
                    <div class="section-content">
                        <div class="info-grid">
                            <div class="info-item">
                                <label>Người liên hệ:</label>
                                <span>{{ user.emergency_contact|default:"Chưa cập nhật" }}</span>
                            </div>
                            <div class="info-item">
                                <label>Số điện thoại:</label>
                                <span>{{ user.emergency_phone|default:"Chưa cập nhật" }}</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Kỹ năng và ghi chú -->
                <div class="profile-section">
                    <h3 class="section-title">
                        <i class="fas fa-star"></i> Kỹ năng & Ghi chú
                    </h3>
                    <div class="section-content">
                        <div class="info-item full-width">
                            <label>Kỹ năng chuyên môn:</label>
                            <div class="skills-content">
                                {{ user.skills|default:"Chưa cập nhật"|linebreaks }}
                            </div>
                        </div>
                        <div class="info-item full-width">
                            <label>Ghi chú thêm:</label>
                            <div class="notes-content">
                                {{ user.notes|default:"Chưa cập nhật"|linebreaks }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/personal/profile.js' %}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Check if coming from avatar upload page
    const isFromUpload = sessionStorage.getItem('avatar_uploaded') === 'true';
    
    // Force reload avatar with cache busting when page loads
    const profileAvatar = document.getElementById('profile-avatar-img');
    if (profileAvatar) {
        const originalSrc = profileAvatar.src;
        const timestamp = new Date().getTime();
        const random = Math.random().toString(36).substring(7);
        const newSrc = originalSrc.split('?')[0] + '?v=' + timestamp + '&r=' + random;
        
        // Force reload avatar
        profileAvatar.style.display = 'none';
        profileAvatar.src = '';
        setTimeout(() => {
            profileAvatar.src = newSrc;
            profileAvatar.style.display = 'block';
            console.log('Profile avatar force reloaded:', newSrc);
        }, 100);
        
        // Fallback with fetch if needed
        setTimeout(() => {
            fetch(newSrc, {cache: 'no-cache'})
                .then(response => response.blob())
                .then(blob => {
                    const url = URL.createObjectURL(blob);
                    profileAvatar.src = url;
                    console.log('Profile avatar force reloaded with blob URL');
                })
                .catch(error => {
                    console.error('Profile avatar force reload failed:', error);
                });
        }, 500);
        
        // If coming from upload, show success message
        if (isFromUpload) {
            showSuccessMessage('✅ Avatar đã được cập nhật thành công!');
            sessionStorage.removeItem('avatar_uploaded');
        }
    }
    
    // Update avatar in header if exists
    const headerAvatar = document.querySelector('.user-avatar img');
    if (headerAvatar) {
        const originalSrc = headerAvatar.src;
        const timestamp = new Date().getTime();
        const random = Math.random().toString(36).substring(7);
        const newSrc = originalSrc.split('?')[0] + '?v=' + timestamp + '&r=' + random;
        
        headerAvatar.style.display = 'none';
        headerAvatar.src = '';
        setTimeout(() => {
            headerAvatar.src = newSrc;
            headerAvatar.style.display = 'block';
            console.log('Header avatar force reloaded:', newSrc);
        }, 200);
    }
    
    // Clear browser cache for avatar images
    if ('caches' in window) {
        caches.keys().then(cacheNames => {
            cacheNames.forEach(cacheName => {
                caches.open(cacheName).then(cache => {
                    // Clear any avatar-related cache entries
                    cache.keys().then(requests => {
                        requests.forEach(request => {
                            if (request.url.includes('avatar') || request.url.includes('media')) {
                                cache.delete(request);
                                console.log('Cleared avatar cache:', request.url);
                            }
                        });
                    });
                });
            });
        });
    }
    
    // Show success message function
    function showSuccessMessage(message) {
        // Remove existing alerts
        const existingAlerts = document.querySelectorAll('.alert');
        existingAlerts.forEach(alert => alert.remove());
        
        // Create success alert
        const alert = document.createElement('div');
        alert.className = 'alert alert-success';
        alert.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 1000; max-width: 300px;';
        alert.innerHTML = message;
        
        // Add to page
        document.body.appendChild(alert);
        
        // Auto remove after 3 seconds
        setTimeout(() => {
            alert.remove();
        }, 3000);
    }
});
</script>
{% endblock %}
