{% extends "base.html" %}
{% load static %}

{% block title %}Cập nhật Avatar - NOV-RECO{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/personal/profile.css' %}">
<style>
.avatar-upload-container {
    max-width: 600px;
    margin: 0 auto;
    padding: 2rem;
}

.avatar-preview {
    text-align: center;
    margin-bottom: 2rem;
}

.avatar-preview img {
    width: 200px;
    height: 200px;
    border-radius: 50%;
    object-fit: cover;
    border: 4px solid #e9ecef;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.avatar-preview .avatar-placeholder {
    width: 200px;
    height: 200px;
    border-radius: 50%;
    background: #f8f9fa;
    border: 4px solid #e9ecef;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto;
    font-size: 4rem;
    color: #6c757d;
}

.upload-form {
    background: white;
    border-radius: 8px;
    padding: 2rem;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.upload-area {
    border: 2px dashed #dee2e6;
    border-radius: 8px;
    padding: 2rem;
    text-align: center;
    transition: all 0.3s ease;
    cursor: pointer;
}

.upload-area:hover {
    border-color: #007bff;
    background-color: #f8f9ff;
}

.upload-area.dragover {
    border-color: #007bff;
    background-color: #e3f2fd;
}

.upload-icon {
    font-size: 3rem;
    color: #6c757d;
    margin-bottom: 1rem;
}

.upload-text {
    color: #6c757d;
    margin-bottom: 1rem;
}

.upload-hint {
    font-size: 0.9rem;
    color: #adb5bd;
}

.file-input {
    display: none;
}

.btn-upload {
    background: #007bff;
    color: white;
    border: none;
    padding: 0.75rem 1.5rem;
    border-radius: 6px;
    cursor: pointer;
    transition: background-color 0.3s ease;
}

.btn-upload:hover {
    background: #0056b3;
}

.btn-upload:disabled {
    background: #6c757d;
    cursor: not-allowed;
}

.upload-progress {
    display: none;
    margin-top: 1rem;
}

.upload-progress .progress {
    height: 8px;
    border-radius: 4px;
}

.upload-actions {
    display: flex;
    gap: 1rem;
    justify-content: center;
    margin-top: 2rem;
}

.alert {
    padding: 1rem;
    border-radius: 6px;
    margin-bottom: 1rem;
}

.alert-success {
    background-color: #d4edda;
    border: 1px solid #c3e6cb;
    color: #155724;
}

.alert-danger {
    background-color: #f8d7da;
    border: 1px solid #f5c6cb;
    color: #721c24;
}

.alert-info {
    background-color: #d1ecf1;
    border: 1px solid #bee5eb;
    color: #0c5460;
}

/* Pulse animation for upload button */
@keyframes pulse {
    0% {
        transform: scale(1);
        box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7);
    }
    70% {
        transform: scale(1.05);
        box-shadow: 0 0 0 10px rgba(40, 167, 69, 0);
    }
    100% {
        transform: scale(1);
        box-shadow: 0 0 0 0 rgba(40, 167, 69, 0);
    }
}

/* Upload area when file is selected */
.upload-area.has-file {
    border-color: #28a745;
    background-color: #d4edda;
}

.upload-area.has-file .upload-icon {
    color: #28a745;
}

.upload-area.has-file .upload-text {
    color: #155724;
}

/* Upload area when upload is successful */
.upload-area.upload-success {
    border-color: #28a745;
    background-color: #d4edda;
    animation: successPulse 2s ease-in-out;
}

.upload-area.upload-success .upload-icon {
    color: #28a745;
}

.upload-area.upload-success .upload-text {
    color: #155724;
}

@keyframes successPulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.02); }
    100% { transform: scale(1); }
}

/* Success button styling */
.btn-success {
    background-color: #28a745;
    border-color: #28a745;
}

.btn-success:hover {
    background-color: #218838;
    border-color: #1e7e34;
}
</style>
{% endblock %}

{% block content %}
<div class="personal-profile-page">
    <div class="container">
        <div class="avatar-upload-container">
            <!-- Header -->
            <div class="text-center mb-4">
                <h1 class="h3 mb-2">Cập nhật Avatar</h1>
                <p class="text-muted">Chọn ảnh đại diện mới cho tài khoản của bạn</p>
            </div>

            <!-- Avatar Preview -->
            <div class="avatar-preview">
                {% if user.avatar %}
                    <img id="avatar-preview" src="{{ user.avatar.url }}" alt="Avatar hiện tại">
                {% else %}
                    <div class="avatar-placeholder">
                        <i class="fas fa-user"></i>
                    </div>
                {% endif %}
            </div>

            <!-- Upload Form -->
            <div class="upload-form">
                <form id="avatar-upload-form" enctype="multipart/form-data">
                    {% csrf_token %}
                    
                    <div class="upload-area" id="upload-area">
                        <div class="upload-icon">
                            <i class="fas fa-cloud-upload-alt"></i>
                        </div>
                        <div class="upload-text">
                            <strong>Kéo thả ảnh vào đây</strong><br>
                            hoặc <span class="text-primary">bấm để chọn file</span>
                        </div>
                        <div class="upload-hint">
                            Hỗ trợ: JPG, PNG, GIF (tối đa 5MB)
                        </div>
                        <input type="file" id="avatar-input" name="avatar" accept="image/*" class="file-input">
                    </div>

                    <div class="upload-progress" id="upload-progress">
                        <div class="progress">
                            <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                        </div>
                        <div class="text-center mt-2">
                            <small class="text-muted">Đang tải lên...</small>
                        </div>
                    </div>

                    <div class="upload-actions">
                        <button type="submit" id="upload-btn" class="btn btn-upload" disabled>
                            <i class="fas fa-upload"></i> Tải lên
                        </button>
                        <button type="button" id="reset-btn" class="btn btn-outline-warning" style="display: none;">
                            <i class="fas fa-redo"></i> Chọn lại
                        </button>
                        <a href="{% url 'personal:profile' %}" class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-left"></i> Quay lại
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const uploadArea = document.getElementById('upload-area');
    const fileInput = document.getElementById('avatar-input');
    const uploadForm = document.getElementById('avatar-upload-form');
    const uploadBtn = document.getElementById('upload-btn');
    const resetBtn = document.getElementById('reset-btn');
    const uploadProgress = document.getElementById('upload-progress');
    const progressBar = uploadProgress.querySelector('.progress-bar');
    const avatarPreview = document.getElementById('avatar-preview');

    // Click to select file
    uploadArea.addEventListener('click', function() {
        fileInput.click();
    });

    // Drag and drop
    uploadArea.addEventListener('dragover', function(e) {
        e.preventDefault();
        uploadArea.classList.add('dragover');
    });

    uploadArea.addEventListener('dragleave', function(e) {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
    });

    uploadArea.addEventListener('drop', function(e) {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            fileInput.files = files;
            handleFileSelect(files[0]);
        }
    });

    // File input change
    fileInput.addEventListener('change', function(e) {
        console.log('File input changed:', e.target.files);
        if (e.target.files.length > 0) {
            console.log('File selected:', e.target.files[0]);
            handleFileSelect(e.target.files[0]);
        }
    });

    // Handle file selection
    function handleFileSelect(file) {
        console.log('Handling file select:', file);
        console.log('File type:', file.type);
        console.log('File size:', file.size);
        
        // Validate file type
        if (!file.type.startsWith('image/')) {
            console.log('Invalid file type');
            showAlert('Vui lòng chọn file hình ảnh!', 'danger');
            return;
        }

        // Validate file size (5MB)
        if (file.size > 5 * 1024 * 1024) {
            console.log('File too large');
            showAlert('File quá lớn! Vui lòng chọn file nhỏ hơn 5MB.', 'danger');
            return;
        }
        
        console.log('File validation passed');

        // Preview image
        console.log('Creating FileReader...');
        const reader = new FileReader();
        reader.onload = function(e) {
            console.log('FileReader onload triggered');
            
            // Update or create preview
            let previewElement = document.getElementById('avatar-preview');
            if (!previewElement) {
                // Create new preview element
                previewElement = document.createElement('img');
                previewElement.id = 'avatar-preview';
                previewElement.alt = 'Avatar preview';
                previewElement.style.cssText = 'width: 200px; height: 200px; border-radius: 50%; object-fit: cover; border: 4px solid #e9ecef; box-shadow: 0 4px 8px rgba(0,0,0,0.1);';
                
                // Replace placeholder with preview
                const placeholder = document.querySelector('.avatar-placeholder');
                if (placeholder) {
                    placeholder.replaceWith(previewElement);
                } else {
                    // Insert into avatar preview container
                    const previewContainer = document.querySelector('.avatar-preview');
                    if (previewContainer) {
                        previewContainer.appendChild(previewElement);
                    }
                }
            }
            
            // Set preview image
            previewElement.src = e.target.result;
            console.log('Avatar preview updated');
            
            // Update upload area visual state
            uploadArea.classList.add('has-file');
            uploadArea.querySelector('.upload-text').innerHTML = '<strong>✅ Ảnh đã được chọn!</strong><br><span class="text-success">Bấm "Tải lên ngay" để cập nhật avatar</span>';
            
            // Show success message
            showAlert('✅ Ảnh đã được chọn! Bấm "Tải lên ngay" để cập nhật avatar.', 'success');
        };
        reader.onerror = function(e) {
            console.error('FileReader error:', e);
            showAlert('❌ Lỗi khi đọc file ảnh!', 'danger');
        };
        console.log('Reading file as data URL...');
        reader.readAsDataURL(file);

        // Enable upload button with visual feedback
        console.log('Enabling upload button');
        uploadBtn.disabled = false;
        uploadBtn.classList.add('btn-success');
        uploadBtn.classList.remove('btn-primary');
        uploadBtn.innerHTML = '<i class="fas fa-upload"></i> Tải lên ngay';
        uploadBtn.style.animation = 'pulse 2s infinite';
        
        // Show reset button
        resetBtn.style.display = 'inline-block';
        
        console.log('Upload button enabled:', !uploadBtn.disabled);
    }

    // Form submission
    uploadForm.addEventListener('submit', function(e) {
        console.log('Form submission triggered');
        e.preventDefault();
        
        const formData = new FormData(uploadForm);
        console.log('FormData created:', formData);
        
        // Show progress
        uploadProgress.style.display = 'block';
        uploadBtn.disabled = true;
        uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang tải lên...';

        // Upload file
        console.log('Starting fetch request...');
        const uploadUrl = '{% url "personal:avatar_upload" %}';
        console.log('Upload URL:', uploadUrl);
        
        fetch(uploadUrl, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => {
            console.log('Response received:', response);
            return response.json();
        })
        .then(data => {
            console.log('Response data:', data);
            uploadProgress.style.display = 'none';
            
            if (data.success) {
                showAlert(data.message, 'success');
                
                // Update avatar preview immediately
                if (avatarPreview) {
                    avatarPreview.src = data.avatar_url + '?t=' + new Date().getTime();
                    console.log('Avatar preview updated with new URL:', data.avatar_url);
                }
                
                // Update avatar in header if exists
                const headerAvatar = document.querySelector('.user-avatar img');
                if (headerAvatar) {
                    headerAvatar.src = data.avatar_url + '?t=' + new Date().getTime();
                    console.log('Header avatar updated');
                }
                
                // Update avatar in profile page if exists
                const profileAvatar = document.querySelector('.profile-avatar img');
                if (profileAvatar) {
                    profileAvatar.src = data.avatar_url + '?t=' + new Date().getTime();
                    console.log('Profile avatar updated');
                }
                
                // Update all avatar images on the page
                const allAvatarImages = document.querySelectorAll('img[src*="avatar"]');
                allAvatarImages.forEach(img => {
                    if (img.src.includes('avatar')) {
                        img.src = data.avatar_url + '?t=' + new Date().getTime();
                    }
                });
                console.log('All avatar images updated');
                
                // Update upload area to show success state
                uploadArea.classList.remove('has-file');
                uploadArea.classList.add('upload-success');
                uploadArea.querySelector('.upload-text').innerHTML = '<strong>✅ Upload thành công!</strong><br><span class="text-success">Avatar đã được cập nhật</span>';
                
                // Update upload button to show success
                uploadBtn.classList.remove('btn-success');
                uploadBtn.classList.add('btn-success');
                uploadBtn.innerHTML = '<i class="fas fa-check"></i> Thành công!';
                uploadBtn.style.animation = '';
                uploadBtn.disabled = true;
                
                // Hide reset button
                resetBtn.style.display = 'none';
                
                // Show redirect message
                setTimeout(() => {
                    showAlert('🔄 Đang chuyển về trang profile...', 'info');
                }, 1000);
                
                // Redirect after 3 seconds
                setTimeout(() => {
                    window.location.href = '{% url "personal:profile" %}';
                }, 3000);
            } else {
                showAlert(data.message, 'danger');
                uploadBtn.disabled = false;
                uploadBtn.innerHTML = '<i class="fas fa-upload"></i> Tải lên';
            }
        })
        .catch(error => {
            console.error('Upload error:', error);
            uploadProgress.style.display = 'none';
            showAlert('Có lỗi xảy ra khi tải lên. Vui lòng thử lại!', 'danger');
            uploadBtn.disabled = false;
            uploadBtn.innerHTML = '<i class="fas fa-upload"></i> Tải lên';
        });
    });

    // Reset button functionality
    resetBtn.addEventListener('click', function() {
        console.log('Reset button clicked');
        
        // Reset file input
        fileInput.value = '';
        
        // Reset upload area
        uploadArea.classList.remove('has-file');
        uploadArea.querySelector('.upload-text').innerHTML = '<strong>Kéo thả ảnh vào đây</strong><br>hoặc <span class="text-primary">bấm để chọn file</span>';
        
        // Reset upload button
        uploadBtn.disabled = true;
        uploadBtn.classList.remove('btn-success');
        uploadBtn.classList.add('btn-primary');
        uploadBtn.innerHTML = '<i class="fas fa-upload"></i> Tải lên';
        uploadBtn.style.animation = '';
        
        // Hide reset button
        resetBtn.style.display = 'none';
        
        // Remove preview if exists
        const previewElement = document.getElementById('avatar-preview');
        if (previewElement) {
            previewElement.remove();
        }
        
        // Show original placeholder
        const previewContainer = document.querySelector('.avatar-preview');
        if (previewContainer && !previewContainer.querySelector('.avatar-placeholder')) {
            const placeholder = document.createElement('div');
            placeholder.className = 'avatar-placeholder';
            placeholder.innerHTML = '<i class="fas fa-user"></i>';
            previewContainer.appendChild(placeholder);
        }
        
        // Clear any alerts
        const existingAlerts = document.querySelectorAll('.alert');
        existingAlerts.forEach(alert => alert.remove());
        
        console.log('Reset completed');
    });

    // Show alert
    function showAlert(message, type) {
        // Remove existing alerts
        const existingAlerts = document.querySelectorAll('.alert');
        existingAlerts.forEach(alert => alert.remove());

        // Create new alert
        const alert = document.createElement('div');
        alert.className = `alert alert-${type}`;
        alert.innerHTML = message;
        
        // Insert after header
        const header = document.querySelector('.text-center.mb-4');
        header.insertAdjacentElement('afterend', alert);

        // Auto remove after 5 seconds
        setTimeout(() => {
            alert.remove();
        }, 5000);
    }
});
</script>
{% endblock %}
